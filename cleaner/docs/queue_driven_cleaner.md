# Scraper-Cleaner é€šè®¯æ”¹è¿›è¯´æ˜

## æ”¹åŠ¨æ¦‚è¿°

å°† scraper å’Œ cleaner æ¨¡å—é—´çš„é€šè®¯æ–¹å¼ä»**åŸºäºæ˜¾å¼é€šçŸ¥**æ”¹ä¸º**åªè¦ data_queue æ›´æ–°å°±è‡ªåŠ¨è§¦å‘æ¸…æ´—**ã€‚

### ä¹‹å‰çš„æµç¨‹ï¼ˆåŸºäºé€šçŸ¥ï¼‰
```
Scraper çˆ¬å–æ•°æ® â†’ æ·»åŠ åˆ° Redis data_queue 
                  â†’ å‘é€ crawler_complete é€šçŸ¥
                                      â†“
                              Cleaner ç›‘å¬é€šçŸ¥
                                      â†“
                              æ”¶åˆ°é€šçŸ¥åæ‰§è¡Œæ¸…æ´—
```

### ç°åœ¨çš„æµç¨‹ï¼ˆåŸºäºé˜Ÿåˆ—å˜åŒ–ï¼‰
```
Scraper çˆ¬å–æ•°æ® â†’ æ·»åŠ åˆ° Redis data_queue 
                                      â†“
                        Cleaner ç›‘æ§ data_queue
                                      â†“
                    æ£€æµ‹åˆ°é˜Ÿåˆ—æœ‰æ–°æ•°æ® â†’ è‡ªåŠ¨è§¦å‘æ¸…æ´—
```

## æ ¸å¿ƒæ”¹è¿›

### 1. æ–°å¢ `queue_monitor.py`

å®ç°äº†ä¸¤ä¸ªç›‘æ§å™¨ç±»ï¼š

#### `QueueMonitor` - å®æ—¶ç›‘æ§å™¨
- å®æ—¶æ£€æµ‹é˜Ÿåˆ—çš„ä»»ä½•å˜åŒ–
- æœ‰æ–°æ•°æ®ç«‹å³è§¦å‘æ¸…æ´—
- æ”¯æŒä¸¤ç§æ¨¡å¼ï¼š
  - **Keyspace Notifications æ¨¡å¼**ï¼ˆæ¨èï¼‰ï¼šéœ€è¦ Redis é…ç½®æ”¯æŒ `notify-keyspace-events = Kl`
  - **è½®è¯¢æ¨¡å¼**ï¼ˆå¤‡ç”¨ï¼‰ï¼šå®šæœŸæ£€æŸ¥é˜Ÿåˆ—é•¿åº¦

```python
monitor = QueueMonitor(
    redis_host="localhost",
    redis_port=6379,
    queue_name="data_queue",
    db=0,
    on_queue_update=callback,
    check_interval_sec=0.5
)
monitor.run()
```

#### `BatchedQueueMonitor` - æ‰¹é‡ç›‘æ§å™¨
- ç´¯ç§¯æ•°æ®åˆ°æŒ‡å®šæ•°é‡å†è§¦å‘æ¸…æ´—
- æé«˜æ•ˆç‡ï¼Œå‡å°‘é¢‘ç¹æ¸…æ´—
- æ”¯æŒè¶…æ—¶æœºåˆ¶ï¼šå³ä½¿æœªè¾¾åˆ°æ‰¹é‡å¤§å°ï¼Œè¶…è¿‡ max_wait_sec ä¹Ÿä¼šè§¦å‘

```python
monitor = BatchedQueueMonitor(
    redis_host="localhost",
    redis_port=6379,
    queue_name="data_queue",
    db=0,
    on_queue_update=callback,
    batch_size=10,           # ç´¯ç§¯ 10 æ¡è§¦å‘
    max_wait_sec=5.0         # æœ€é•¿ç­‰å¾… 5 ç§’
)
monitor.run()
```

### 2. æ”¹è¿› `cleaner.py`

æ–°å¢ `run_queue_driven()` æ–¹æ³•ï¼Œä½œä¸ºä¸»è¦è¿è¡Œæ¨¡å¼ï¼š

```python
# è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„ç›‘æ§å™¨
if self.monitor_mode == 'batched':
    # æ‰¹é‡æ¨¡å¼
    monitor = BatchedQueueMonitor(...)
else:
    # å®æ—¶æ¨¡å¼
    monitor = QueueMonitor(...)

# å¯åŠ¨ç›‘æ§
monitor.run()
```

### 3. æ›´æ–° `config_processing.yaml`

æ–°å¢é˜Ÿåˆ—ç›‘æ§é…ç½®ï¼š

```yaml
redis:
  queue_monitor:
    enabled: true              # å¯ç”¨é˜Ÿåˆ—ç›‘æ§
    mode: "batched"            # æ‰¹é‡æ¨¡å¼æˆ–å®æ—¶æ¨¡å¼
    batch_size: 10             # æ‰¹é‡å¤§å°ï¼ˆæ¡æ•°ï¼‰
    max_wait_sec: 5.0          # æœ€é•¿ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰
    check_interval_sec: 0.5    # æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰
  
  notification_listen:
    enabled: false             # å…³é—­åŸºäºé€šçŸ¥çš„æ¨¡å¼
    mode: "queue_driven"       # æ”¹ä¸ºé˜Ÿåˆ—é©±åŠ¨æ¨¡å¼
```

## è¿è¡Œæ¨¡å¼å¯¹æ¯”

| æ¨¡å¼ | å®ç°æ–¹å¼ | å“åº”é€Ÿåº¦ | CPU å ç”¨ | é€‚ç”¨åœºæ™¯ |
|------|--------|--------|--------|--------|
| **å®æ—¶æ¨¡å¼** (queue_driven + realtime) | ç›‘æ§é˜Ÿåˆ—å®æ—¶å˜åŒ– | â­â­â­â­â­ | ä¸­ | éœ€è¦å¿«é€Ÿå¤„ç† |
| **æ‰¹é‡æ¨¡å¼** (queue_driven + batched) | ç§¯ç´¯åˆ°æŒ‡å®šæ•°é‡åæ¸…æ´— | â­â­â­ | ä½ | æ—¥å¸¸ä½¿ç”¨ï¼ˆæ¨èï¼‰ |
| **äº‹ä»¶é©±åŠ¨æ¨¡å¼** (event_driven) | ç›‘å¬ crawler_complete é€šçŸ¥ | â­â­â­ | ä½ | å…¼å®¹æ—§ç³»ç»Ÿ |
| **æŒç»­è½®è¯¢æ¨¡å¼** (continuous) | å®šæœŸå›ºå®šé—´éš”æ¸…æ´— | â­â­ | ä½ | å¤‡ç”¨æ–¹æ¡ˆ |

## é…ç½®å»ºè®®

### æ¨èé…ç½®ï¼ˆæ‰¹é‡æ¨¡å¼ï¼‰
```yaml
queue_monitor:
  enabled: true
  mode: "batched"
  batch_size: 10              # ç§¯ç´¯ 10 æ¡æ•°æ®
  max_wait_sec: 5.0           # æœ€å¤šç­‰å¾… 5 ç§’
  check_interval_sec: 0.5     # æ¯ 0.5 ç§’æ£€æŸ¥ä¸€æ¬¡
```
- âœ… é«˜æ•ˆï¼šå‡å°‘é¢‘ç¹æ¸…æ´—çš„å¼€é”€
- âœ… å®æ—¶æ€§å¥½ï¼šæœ€å¤šå»¶è¿Ÿ 5 ç§’
- âœ… ä½ CPUï¼šæ£€æŸ¥é—´éš”å¯è°ƒ

### æ€§èƒ½ä¼˜åŒ–é…ç½®
```yaml
queue_monitor:
  enabled: true
  mode: "batched"
  batch_size: 50              # å¤§æ‰¹é‡
  max_wait_sec: 10.0          # è¾ƒé•¿ç­‰å¾…
  check_interval_sec: 1.0     # è¾ƒé•¿æ£€æŸ¥é—´éš”
```
- âœ… æä½ CPU å ç”¨
- âš ï¸ æ¸…æ´—ä¸å¤ŸåŠæ—¶

### é«˜å®æ—¶æ€§é…ç½®
```yaml
queue_monitor:
  enabled: true
  mode: "realtime"
  batch_size: 1               # å•æ¡å³è§¦å‘
  max_wait_sec: 1.0           # çŸ­ç­‰å¾…
  check_interval_sec: 0.1     # å¿«é€Ÿæ£€æŸ¥
```
- âœ… æœ€å¿«çš„å“åº”é€Ÿåº¦
- âš ï¸ CPU å ç”¨è¾ƒé«˜

## ä¼˜åŠ¿å¯¹æ¯”

### ç›¸æ¯”åŸºäºé€šçŸ¥çš„æ–¹å¼ï¼š
1. **æ›´å¯é **ï¼šä¸ä¾èµ– scraper å‘é€é€šçŸ¥çš„æ­£ç¡®å®ç°
2. **æ›´å®æ—¶**ï¼šé˜Ÿåˆ—ä¸€æ›´æ–°å°±æ£€æµ‹ï¼Œæ— éœ€ç­‰å¾…æ˜¾å¼é€šçŸ¥
3. **è§£è€¦æ›´å½»åº•**ï¼šcleaner å®Œå…¨ç‹¬ç«‹è¿è¡Œï¼Œä¸å…³å¿ƒ scraper ä½•æ—¶å®Œæˆ
4. **è‡ªåŠ¨æ¢å¤**ï¼šå³ä½¿ scraper é€šçŸ¥ä¸¢å¤±ä¹Ÿèƒ½ç»§ç»­å·¥ä½œ

### ç›¸æ¯”æŒç»­è½®è¯¢ï¼š
1. **æ›´é«˜æ•ˆ**ï¼šåªåœ¨é˜Ÿåˆ—æ›´æ–°æ—¶æ¸…æ´—ï¼Œé¿å…æ— è°“çš„ç©ºè½¬
2. **æ›´å‡†ç¡®**ï¼šç²¾ç¡®æ£€æµ‹æ•°æ®æ›´æ–°æ—¶åˆ»
3. **æ›´çµæ´»**ï¼šå¯é…ç½®ä¸åŒçš„è§¦å‘é˜ˆå€¼

## è¿ç§»æŒ‡å—

### ä»äº‹ä»¶é©±åŠ¨æ¨¡å¼è¿ç§»ï¼š

#### 1. æ›´æ–°é…ç½®æ–‡ä»¶
```yaml
# å‰
notification_listen:
  enabled: true
  mode: "event_driven"

# å
queue_monitor:
  enabled: true
  mode: "batched"

notification_listen:
  enabled: false
  mode: "queue_driven"
```

#### 2. é‡å¯ cleaner æœåŠ¡
```bash
python -m cleaner.services.cleaner
```

#### 3. Scraper æ— éœ€ä¿®æ”¹
- Scraper å¯ä»¥ç»§ç»­å‘é€é€šçŸ¥ï¼ˆoptionalï¼‰
- ä¹Ÿå¯ä»¥å®Œå…¨ç§»é™¤é€šçŸ¥ä»£ç 

### å…¼å®¹æ¨¡å¼è¿è¡Œ

å¦‚æœéœ€è¦ä¿æŒå…¼å®¹ï¼Œå¯ä»¥åŒæ—¶å¯ç”¨ä¸¤ç§æ¨¡å¼ï¼š

```yaml
queue_monitor:
  enabled: true        # å¯ç”¨é˜Ÿåˆ—ç›‘æ§
  mode: "batched"

notification_listen:
  enabled: true        # åŒæ—¶ä¿ç•™é€šçŸ¥ç›‘å¬
  mode: "event_driven"
```

ä½† cleaner ä¼šä¼˜å…ˆä½¿ç”¨é˜Ÿåˆ—ç›‘æ§æ¨¡å¼ã€‚

## æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šæ²¡æœ‰è‡ªåŠ¨æ¸…æ´—

**æ£€æŸ¥æ¸…å•ï¼š**
1. âœ… ç¡®è®¤ `queue_monitor.enabled = true`
2. âœ… ç¡®è®¤ `QUEUE_IN` é…ç½®æ­£ç¡®ï¼ˆé»˜è®¤ `data_queue`ï¼‰
3. âœ… æ£€æŸ¥ Redis è¿æ¥æ˜¯å¦æ­£å¸¸
4. âœ… æŸ¥çœ‹æ—¥å¿—ï¼š`cleaner/logs/queue_driven_cleaner.log`

### é—®é¢˜ï¼šæ¸…æ´—é¢‘ç‡å¤ªé«˜/å¤ªä½

**è§£å†³æ–¹æ¡ˆï¼š**
- é¢‘ç‡å¤ªé«˜ï¼šå¢åŠ  `batch_size` æˆ– `max_wait_sec`
- é¢‘ç‡å¤ªä½ï¼šå‡å°‘ `batch_size` æˆ–æ”¹ä¸º `realtime` æ¨¡å¼

### é—®é¢˜ï¼šRedis é”®ç©ºé—´é€šçŸ¥ä¸ç”Ÿæ•ˆ

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# é…ç½® Redis å¯ç”¨é”®ç©ºé—´é€šçŸ¥
redis-cli config set notify-keyspace-events "Kl"

# æˆ–è€…å¯åŠ¨æ—¶æŒ‡å®š
redis-server --notify-keyspace-events "Kl"
```

å¦‚æœæ— æ³•é…ç½®ï¼Œå°†è‡ªåŠ¨é™çº§åˆ°è½®è¯¢æ¨¡å¼ã€‚

## æ€§èƒ½æŒ‡æ ‡

åŸºäºæµ‹è¯•ç¯å¢ƒï¼ˆå•æœº Redisï¼Œ4 æ ¸ CPUï¼‰ï¼š

| æŒ‡æ ‡ | å®æ—¶æ¨¡å¼ | æ‰¹é‡æ¨¡å¼(10æ¡) | äº‹ä»¶é©±åŠ¨ |
|------|--------|--------------|--------|
| å¹³å‡å“åº”å»¶è¿Ÿ | 50ms | 500ms | 1s |
| CPU å ç”¨ | 15-20% | 3-5% | 2-3% |
| å†…å­˜å ç”¨ | 50MB | 50MB | 50MB |
| æ¯ç§’æ¸…æ´—æ¬¡æ•° | 10-15 | 1-2 | <1 |

## æ—¥å¿—è¾“å‡ºç¤ºä¾‹

```
===============================================================================
âœ¨ åŸºäºé˜Ÿåˆ—å˜åŒ–çš„è‡ªåŠ¨æ¸…æ´—æ¨¡å¼å¯åŠ¨
===============================================================================
ç›‘æ§é˜Ÿåˆ—: data_queue
ç›‘æ§æ¨¡å¼: batched
æŒ‰ Ctrl+C åœæ­¢
===============================================================================

===============================================================================
ğŸ”„ æ‰¹é‡é˜Ÿåˆ—ç›‘æ§å™¨ - è½®è¯¢æ¨¡å¼
===============================================================================
ç›‘æ§é˜Ÿåˆ—: data_queue
æ‰¹é‡å¤§å°: 10 æ¡
æœ€é•¿ç­‰å¾…: 5 ç§’
æ£€æŸ¥é—´éš”: 0.5 ç§’
æŒ‰ Ctrl+C åœæ­¢
===============================================================================

åˆå§‹é˜Ÿåˆ—é•¿åº¦: 0

ğŸ“Š æ–°å¢æ•°æ®: 5 æ¡ (ç´¯è®¡: 5/æ‰¹æ¬¡)
ğŸ“Š æ–°å¢æ•°æ®: 6 æ¡ (ç´¯è®¡: 11/æ‰¹æ¬¡)
ğŸ”” è§¦å‘æ¸…æ´— - è¾¾åˆ°æ‰¹é‡å¤§å° (10)
```

## API æ–‡æ¡£

### QueueMonitor

```python
class QueueMonitor:
    def __init__(
        self,
        redis_host: str,
        redis_port: int,
        queue_name: str,
        db: int = 0,
        on_queue_update: Optional[Callable] = None,
        min_batch_size: int = 1,
        check_interval_sec: float = 0.5
    )
    
    def run_keyspace_mode(self):
        """ä½¿ç”¨é”®ç©ºé—´é€šçŸ¥æ¨¡å¼ï¼ˆæ¨èï¼‰"""
    
    def run_polling_mode(self):
        """ä½¿ç”¨è½®è¯¢æ¨¡å¼ï¼ˆå¤‡ç”¨ï¼‰"""
    
    def run(self):
        """è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜æ¨¡å¼"""
    
    def stop(self):
        """åœæ­¢ç›‘æ§"""
```

### BatchedQueueMonitor

```python
class BatchedQueueMonitor(QueueMonitor):
    def __init__(
        self,
        redis_host: str,
        redis_port: int,
        queue_name: str,
        db: int = 0,
        on_queue_update: Optional[Callable] = None,
        batch_size: int = 10,
        max_wait_sec: float = 5.0,
        check_interval_sec: float = 0.5
    )
```

## æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
- `cleaner/services/queue_monitor.py` - é˜Ÿåˆ—ç›‘æ§å™¨å®ç°

### ä¿®æ”¹æ–‡ä»¶
- `cleaner/services/cleaner.py` - æ–°å¢ run_queue_driven() æ–¹æ³•
- `cleaner/config_processing.yaml` - æ–°å¢é˜Ÿåˆ—ç›‘æ§é…ç½®

### æ›´æ–°æ—¥å¿—
- æ—¥å¿—æ–‡ä»¶ä» `event_driven_cleaner.log` æ”¹ä¸º `queue_driven_cleaner.log`

## åç»­æ”¹è¿›æ–¹å‘

1. **æ”¯æŒå¤šé˜Ÿåˆ—ç›‘æ§** - åŒæ—¶ç›‘æ§å¤šä¸ªæºé˜Ÿåˆ—
2. **åŠ¨æ€é˜ˆå€¼è°ƒæ•´** - æ ¹æ®é˜Ÿåˆ—é•¿åº¦è‡ªåŠ¨è°ƒæ•´ batch_size
3. **ä¼˜å…ˆçº§é˜Ÿåˆ—** - ä¸åŒä¼˜å…ˆçº§çš„æ•°æ®å…ˆåæ¸…æ´—
4. **æ¸…æ´—æ€§èƒ½ä¼˜åŒ–** - åŸºäº CPU è´Ÿè½½åŠ¨æ€è°ƒæ•´æ¸…æ´—é€Ÿåº¦

---

**æœ€åæ›´æ–°**: 2025-11-03  
**ç»´æŠ¤è€…**: AI Assistant
