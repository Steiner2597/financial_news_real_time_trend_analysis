# âœ… Cleaner æ—§é€»è¾‘æ¸…ç†å®Œæˆ

## ğŸ§¹ æ¸…ç†å·¥ä½œ

### å·²åˆ é™¤çš„æ—§ä¾èµ–
1. âœ… `data_cleaner_module.py` - å®Œå…¨ç§»é™¤ä¾èµ–
2. âœ… `cursor_loop()` - åˆ é™¤é˜»å¡å¾ªç¯
3. âœ… `RedisConnector` - ä½¿ç”¨ç›´æ¥çš„ Redis è¿æ¥
4. âœ… `Exporter` - é›†æˆåˆ° SinglePassCleaner

### é‡å‘½åçš„æ–‡ä»¶
- `data_cleaner_event_driven_v2.py` â†’ `data_cleaner_event_driven.py` âœ…

## ğŸ“ æœ€ç»ˆæ–‡ä»¶ç»“æ„

```
cleaner/
â”œâ”€â”€ ğŸ“„ data_cleaner_event_driven.py     # ä¸»å…¥å£ âœ… æ–°
â”œâ”€â”€ ğŸš€ start_cleaner.bat                # å¯åŠ¨è„šæœ¬ âœ… æ–°
â”œâ”€â”€ ğŸ§ª test_single_pass_cleaning.py     # æµ‹è¯•è„šæœ¬ âœ… æ–°
â”œâ”€â”€ âš™ï¸  config_processing.yaml          # é…ç½®æ–‡ä»¶
â”‚
â””â”€â”€ ğŸ“‚ event_driven/                     # æ ¸å¿ƒæ¨¡å—
    â”œâ”€â”€ cleaner.py                       # âœ… å·²æ›´æ–°ï¼šç›´æ¥ä»é…ç½®æ–‡ä»¶åŠ è½½
    â”œâ”€â”€ single_pass_cleaner.py           # âœ… æ–°å¢ï¼šå•æ¬¡æ¸…æ´—é€»è¾‘
    â”œâ”€â”€ redis_manager.py
    â”œâ”€â”€ notification_handler.py
    â”œâ”€â”€ cache_manager.py
    â””â”€â”€ signal_handler.py
```

## ğŸ”‘ å…³é”®æ”¹åŠ¨

### 1. cleaner.py - é…ç½®åŠ è½½

**æ”¹åŠ¨å‰**:
```python
try:
    from data_cleaner_module import CONFIG, ...
except ImportError:
    # å¤‡ç”¨æ–¹æ¡ˆ
```

**æ”¹åŠ¨å** âœ…:
```python
# ç›´æ¥ä»é…ç½®æ–‡ä»¶åŠ è½½
import yaml
config_path = Path(__file__).parent.parent / "config_processing.yaml"
with open(config_path, 'r', encoding='utf-8') as f:
    CONFIG = yaml.safe_load(f)
```

### 2. cleaner.py - æ¸…æ´—é€»è¾‘

**æ”¹åŠ¨å‰**:
```python
def _run_cleaning(self):
    cursor_loop()  # âŒ æ— é™å¾ªç¯
```

**æ”¹åŠ¨å** âœ…:
```python
def _run_cleaning(self):
    cleaner = SinglePassCleaner(...)
    stats = cleaner.clean_once()  # âœ… å•æ¬¡å¤„ç†
    return stats['cleaned']
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å¯åŠ¨æ¸…æ´—å™¨

```bash
# æ–¹å¼ 1: å¯åŠ¨è„šæœ¬
cd cleaner
start_cleaner.bat

# æ–¹å¼ 2: ç›´æ¥è¿è¡Œ
python data_cleaner_event_driven.py

# æ–¹å¼ 3: æŒ‡å®šæ¨¡å¼
python data_cleaner_event_driven.py --mode event_driven
python data_cleaner_event_driven.py --mode continuous
python data_cleaner_event_driven.py --mode once
```

### æµ‹è¯•éªŒè¯

```bash
cd cleaner
python test_single_pass_cleaning.py
```

## ğŸ“Š å®Œæ•´å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Scraper (çˆ¬è™«)                          â”‚
â”‚  - çˆ¬å–æ•°æ®                               â”‚
â”‚  - æ¨é€åˆ° Redis DB0: data_queue          â”‚
â”‚  - å‘é€é€šçŸ¥: crawler_complete            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cleaner (æ¸…æ´—å™¨) âœ… æ–°é€»è¾‘                â”‚
â”‚  - æ”¶åˆ°é€šçŸ¥                               â”‚
â”‚  - æ‰§è¡Œ clean_once()                     â”‚
â”‚  - åªå¤„ç†å½“å‰é˜Ÿåˆ—                         â”‚
â”‚  - æ¨é€åˆ° Redis DB1: clean_data_queue    â”‚
â”‚  - å‘é€é€šçŸ¥: cleaner_complete            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Processor (å¤„ç†å™¨)                       â”‚
â”‚  - æ”¶åˆ°é€šçŸ¥                               â”‚
â”‚  - ä» DB1 è¯»å–æ¸…æ´—åçš„æ•°æ®                â”‚
â”‚  - æ‰§è¡Œåˆ†æå¤„ç†                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âœ¨ æ ¸å¿ƒä¼˜åŠ¿

| æ–¹é¢ | æ—§é€»è¾‘ | æ–°é€»è¾‘ |
|-----|--------|--------|
| **ä¾èµ–** | âŒ ä¾èµ– data_cleaner_module | âœ… ç‹¬ç«‹é…ç½®æ–‡ä»¶ |
| **å¾ªç¯** | âŒ cursor_loop() æ— é™å¾ªç¯ | âœ… clean_once() å•æ¬¡å¤„ç† |
| **é˜»å¡** | âŒ ä¸€ç›´é˜»å¡ | âœ… å¤„ç†å®Œç«‹å³è¿”å› |
| **é€šçŸ¥** | âŒ æ— æ³•å‘é€ | âœ… åŠæ—¶å‘é€ |
| **æµç¨‹** | âŒ å¡ä½ | âœ… é¡ºç•… |
| **ä»£ç ** | âŒ è€¦åˆä¸¥é‡ | âœ… æ¨¡å—ç‹¬ç«‹ |

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. éé˜»å¡å¤„ç†
```python
# å•æ¬¡å¤„ç†é€»è¾‘
queue_length = get_current_length()  # è·å–å½“å‰æ•°é‡
for i in range(queue_length):        # åªå¤„ç†è¿™äº›
    process_item()
return stats                          # å¤„ç†å®Œè¿”å›
```

### 2. æ˜ç¡®çš„è¾¹ç•Œ
- åªå¤„ç†å½“å‰é˜Ÿåˆ—ä¸­çš„æ•°æ®
- ä¸ç­‰å¾…æ–°æ•°æ®
- å¤„ç†å®Œç«‹å³è¿”å›

### 3. æ‰¹é‡ä¼˜åŒ–
- 100 æ¡/æ‰¹å¤„ç†
- å‡å°‘ Redis æ“ä½œæ¬¡æ•°
- æé«˜å¤„ç†æ•ˆç‡

### 4. è¯¦ç»†ç»Ÿè®¡
```python
{
    'total_processed': 1000,
    'cleaned': 850,
    'duplicates': 100,
    'invalid': 50
}
```

## ğŸ§ª æµ‹è¯•ç»“æœ

è¿è¡Œæµ‹è¯•åº”è¯¥çœ‹åˆ°ï¼š
```
âœ“ SinglePassCleaner åˆ›å»ºæˆåŠŸ
âœ“ EventDrivenCleaner åˆå§‹åŒ–æˆåŠŸ
âœ“ æ‰€æœ‰æ¨¡å—æ­£å¸¸å·¥ä½œ
âœ… æµ‹è¯•é€šè¿‡ï¼
```

## ğŸ“ é…ç½®è¯´æ˜

`config_processing.yaml` ä¸­çš„å…³é”®é…ç½®ï¼š

```yaml
redis:
  host: "localhost"
  port: 6379
  db_in: 0                    # è¾“å…¥æ•°æ®åº“ï¼ˆä» Scraperï¼‰
  db_out: 1                   # è¾“å‡ºæ•°æ®åº“ï¼ˆç»™ Processorï¼‰
  data_queue: "data_queue"    # è¾“å…¥é˜Ÿåˆ—
  clean_data_queue: "clean_data_queue"  # è¾“å‡ºé˜Ÿåˆ—
  
  notification_listen:
    enabled: true
    channel: "crawler_complete"
    mode: "event_driven"
  
  notification_send:
    enabled: true
    channel: "cleaner_complete"
```

## ğŸ‰ æ€»ç»“

### å®Œæˆçš„å·¥ä½œ
- âœ… åˆ é™¤ data_cleaner_module ä¾èµ–
- âœ… ç§»é™¤é˜»å¡çš„ cursor_loop
- âœ… å®ç°å•æ¬¡æ¸…æ´—é€»è¾‘
- âœ… é‡å‘½åä¸ºä¸»ç‰ˆæœ¬
- âœ… åˆ›å»ºå¯åŠ¨è„šæœ¬
- âœ… æ›´æ–°æ‰€æœ‰æ–‡æ¡£

### ç°åœ¨çš„ä¼˜åŠ¿
- ğŸš€ å®Œå…¨ç‹¬ç«‹ï¼Œä¸ä¾èµ–æ—§æ¨¡å—
- ğŸ¯ å•æ¬¡å¤„ç†ï¼Œä¸é˜»å¡æµç¨‹
- ğŸ’ª ä»£ç ç®€æ´ï¼Œæ˜“äºç»´æŠ¤
- ğŸ“Š ç»Ÿè®¡è¯¦ç»†ï¼Œä¾¿äºç›‘æ§
- ğŸ”„ æµç¨‹é¡ºç•…ï¼Œä¸‰ä¸ªæ¨¡å—ååŒå·¥ä½œ

**å¯ä»¥å¼€å§‹ä½¿ç”¨å…¨æ–°çš„æ¸…æ´—å™¨äº†ï¼** ğŸŠ

## ğŸš¦ ä¸‹ä¸€æ­¥

1. **å¯åŠ¨æ¸…æ´—å™¨**
   ```bash
   cd cleaner
   start_cleaner.bat
   ```

2. **è§¦å‘çˆ¬è™«**
   - è¿è¡Œ Scraper çˆ¬å–æ•°æ®
   - Scraper ä¼šå‘é€ `crawler_complete` é€šçŸ¥

3. **éªŒè¯æµç¨‹**
   - Cleaner æ”¶åˆ°é€šçŸ¥
   - æ‰§è¡Œå•æ¬¡æ¸…æ´—
   - å‘é€ `cleaner_complete` é€šçŸ¥
   - Processor å¼€å§‹å¤„ç†

4. **æ£€æŸ¥æ—¥å¿—**
   - `cleaner/logs/event_driven_cleaner.log`
   - æŸ¥çœ‹æ¸…æ´—ç»Ÿè®¡ä¿¡æ¯

**æ•´ä¸ªæ•°æ®æµç¨‹ç°åœ¨åº”è¯¥é¡ºç•…è¿è¡Œï¼Œä¸ä¼šå†å¡åœ¨æ¸…æ´—é˜¶æ®µäº†ï¼** âœ…
