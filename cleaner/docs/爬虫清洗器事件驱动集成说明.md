# çˆ¬è™«-æ¸…æ´—å™¨äº‹ä»¶é©±åŠ¨é›†æˆè¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜çˆ¬è™«ï¼ˆScraperï¼‰å’Œæ¸…æ´—å™¨ï¼ˆCleanerï¼‰ä¹‹é—´çš„**äº‹ä»¶é©±åŠ¨**é›†æˆæœºåˆ¶ã€‚

### å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Scraper  â”‚  â”€â”€â”€ æ•°æ® â”€â”€â”€>     â”‚  Redis   â”‚  â”€â”€â”€ æ•°æ® â”€â”€â”€>     â”‚ Cleaner  â”‚
â”‚          â”‚                    â”‚  Queue   â”‚                    â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                                â”‚
     â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
     â””â”€â”€â”€â”€ å®Œæˆé€šçŸ¥ â”€â”€â”€â”€â”€>      â”‚ Redis    â”‚  â”€â”€â”€ è§¦å‘æ¸…æ´— â”€â”€â”€â”€â”€â”€>  â”‚
                               â”‚ Pub/Sub  â”‚                         â”‚
                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
                                                                     â†“
                                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                            â”‚ Processor    â”‚
                                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ”¹è¿›ç‚¹

**ä¹‹å‰**ï¼š
- âŒ Cleaner æŒç»­è½®è¯¢ Redis é˜Ÿåˆ—
- âŒ å³ä½¿æ²¡æœ‰æ–°æ•°æ®ä¹Ÿåœ¨è¿è¡Œ
- âŒ èµ„æºæµªè´¹ï¼Œæ•ˆç‡ä½

**ç°åœ¨**ï¼š
- âœ… Scraper å®Œæˆçˆ¬å–åå‘é€é€šçŸ¥
- âœ… Cleaner æ”¶åˆ°é€šçŸ¥åæ‰å¼€å§‹æ¸…æ´—
- âœ… æŒ‰éœ€æ‰§è¡Œï¼ŒèŠ‚çœèµ„æº
- âœ… æ›´æ¸…æ™°çš„æ•°æ®æµæ§åˆ¶

## ğŸ”§ é…ç½®è¯´æ˜

### 1. Scraper é…ç½® (`scraper/config.yaml`)

```yaml
redis:
  # ... å…¶ä»–é…ç½® ...
  
  # é€šçŸ¥æ¸ é“é…ç½®
  notification:
    enabled: true              # å¯ç”¨é€šçŸ¥åŠŸèƒ½
    channel: "crawler_complete"  # é€šçŸ¥é¢‘é“åç§°
```

**å‚æ•°è¯´æ˜**ï¼š
- `enabled`: æ˜¯å¦å¯ç”¨é€šçŸ¥ï¼ˆ`true`/`false`ï¼‰
- `channel`: é€šçŸ¥é¢‘é“åç§°ï¼ˆå¿…é¡»ä¸ Cleaner ä¸€è‡´ï¼‰

### 2. Cleaner é…ç½® (`cleaner/config_processing.yaml`)

```yaml
redis:
  # ... å…¶ä»–é…ç½® ...
  
  # é€šçŸ¥ç›‘å¬é…ç½®
  notification:
    enabled: true              # å¯ç”¨é€šçŸ¥é©±åŠ¨
    channel: "crawler_complete"  # ç›‘å¬é¢‘é“ï¼ˆä¸ Scraper ä¸€è‡´ï¼‰
    mode: "event_driven"       # è¿è¡Œæ¨¡å¼
```

**å‚æ•°è¯´æ˜**ï¼š
- `enabled`: æ˜¯å¦å¯ç”¨é€šçŸ¥é©±åŠ¨ï¼ˆ`true`/`false`ï¼‰
- `channel`: ç›‘å¬çš„é¢‘é“åç§°ï¼ˆå¿…é¡»ä¸ Scraper ä¸€è‡´ï¼‰
- `mode`: è¿è¡Œæ¨¡å¼
  - `"event_driven"`: äº‹ä»¶é©±åŠ¨ï¼Œç­‰å¾…é€šçŸ¥
  - `"continuous"`: æŒç»­è½®è¯¢ï¼ˆå…¼å®¹æ—§æ¨¡å¼ï¼‰

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å®Œæ•´æ•°æ®ç®¡é“å¯åŠ¨é¡ºåº

#### 1. å¯åŠ¨ Redis
```cmd
cd scraper
start_redis.bat
```

#### 2. å¯åŠ¨ Cleanerï¼ˆäº‹ä»¶é©±åŠ¨æ¨¡å¼ï¼‰
```cmd
cd cleaner
start_cleaner.bat
```

è¿™ä¼šå¯åŠ¨æ¸…æ´—å™¨å¹¶ç­‰å¾…çˆ¬è™«é€šçŸ¥ã€‚ä½ ä¼šçœ‹åˆ°ï¼š
```
====================================================================
ğŸ§ äº‹ä»¶é©±åŠ¨æ¨¡å¼å¯åŠ¨
ç­‰å¾…çˆ¬è™«å®Œæˆé€šçŸ¥...
æŒ‰ Ctrl+C åœæ­¢
====================================================================
```

#### 3. å¯åŠ¨ Scraperï¼ˆå¾ªç¯æ¨¡å¼ï¼‰
```cmd
cd scraper
python control_center.py --loop
```

#### 4. å¯åŠ¨ Processorï¼ˆæŒç»­å¤„ç†ï¼‰
```cmd
cd processer
start_processor.bat
```

#### 5. å¯åŠ¨ Visualization
```cmd
cd visualization
# å¯åŠ¨å‰åç«¯...
```

### è¿è¡Œæ¨¡å¼é€‰æ‹©

#### æ¨¡å¼ 1: äº‹ä»¶é©±åŠ¨ï¼ˆæ¨èï¼‰

**ç‰¹ç‚¹**ï¼š
- âœ… èµ„æºé«˜æ•ˆ
- âœ… æŒ‰éœ€æ‰§è¡Œ
- âœ… æ¸…æ™°çš„æ•°æ®æµ

**å¯åŠ¨**ï¼š
```cmd
cd cleaner
start_cleaner.bat
```

æˆ–æŒ‡å®šæ¨¡å¼ï¼š
```cmd
python data_cleaner_event_driven.py --mode event_driven
```

#### æ¨¡å¼ 2: æŒç»­è½®è¯¢ï¼ˆå…¼å®¹æ—§ç³»ç»Ÿï¼‰

**ç‰¹ç‚¹**ï¼š
- âœ… æ— éœ€é€šçŸ¥æœºåˆ¶
- âœ… ç‹¬ç«‹è¿è¡Œ
- âŒ æŒç»­å ç”¨èµ„æº

**å¯åŠ¨**ï¼š
```cmd
python data_cleaner_event_driven.py --mode continuous
```

#### æ¨¡å¼ 3: å•æ¬¡è¿è¡Œ

**ç‰¹ç‚¹**ï¼š
- âœ… é€‚åˆæµ‹è¯•
- âœ… æ‰‹åŠ¨è§¦å‘
- âœ… æ‰§è¡Œå®Œé€€å‡º

**å¯åŠ¨**ï¼š
```cmd
run_once_clean.bat
```

æˆ–ï¼š
```cmd
python data_cleaner_event_driven.py --mode once
```

## ğŸ“Š è¿è¡Œæ—¥å¿—ç¤ºä¾‹

### Scraper å®Œæˆçˆ¬å–

```
============================================================
å¼€å§‹æ‰§è¡ŒæŠ“å–ä»»åŠ¡ - 2025-11-01 14:00:00
============================================================

âœ“ Reddit çˆ¬è™«è¿è¡Œ
âœ“ NewsAPI çˆ¬è™«è¿è¡Œ
âœ“ RSS çˆ¬è™«è¿è¡Œ

============================================================
ç»Ÿè®¡ä¿¡æ¯
============================================================
Reddit:      å¸–å­ 50, è¯„è®º 100, é”™è¯¯ 0
NewsAPI:     æ–‡ç«  25, é”™è¯¯ 0
RSS:         æ–‡ç«  80, é”™è¯¯ 0
------------------------------------------------------------
æ€»è®¡:        æ•°æ® 255, é”™è¯¯ 0
é˜Ÿåˆ—é•¿åº¦:    255
============================================================

ğŸ“¢ é€šçŸ¥å·²å‘é€åˆ°é¢‘é“ 'crawler_complete' (1 ä¸ªè®¢é˜…è€…)
```

### Cleaner æ”¶åˆ°é€šçŸ¥

```
====================================================================
ğŸ“¬ æ”¶åˆ°çˆ¬è™«å®Œæˆé€šçŸ¥
====================================================================
äº‹ä»¶ç±»å‹: crawl_complete
æ—¶é—´æˆ³: 2025-11-01T14:00:30
æ€»æ•°æ®é‡: 255
é˜Ÿåˆ—é•¿åº¦: 255
--------------------------------------------------------------------
  reddit: {'posts': 50, 'comments': 100, 'errors': 0}
  newsapi: {'articles': 25, 'errors': 0}
  rss: {'articles': 80, 'errors': 0}
====================================================================
ğŸš€ å¼€å§‹æ‰§è¡Œæ•°æ®æ¸…æ´—...
====================================================================

[æ­£åœ¨æ¸…æ´—æ•°æ®...]

====================================================================
âœ¨ æ•°æ®æ¸…æ´—å®Œæˆ
====================================================================

ğŸ“¦ å¯¼å‡ºæ¸…æ´—ç»“æœåˆ°æ–‡ä»¶...
[Exporter] JSONL å¯¼å‡ºå®Œæˆï¼šoutput/cleaned_2025-11-01.jsonl
```

## ğŸ¯ é€šçŸ¥æ¶ˆæ¯æ ¼å¼

### Scraper å‘é€çš„é€šçŸ¥

```json
{
  "event": "crawl_complete",
  "timestamp": "2025-11-01T14:00:30.123456",
  "statistics": {
    "total_items": 255,
    "total_errors": 0,
    "queue_length": 255,
    "by_source": {
      "reddit": {
        "posts": 50,
        "comments": 100,
        "errors": 0
      },
      "newsapi": {
        "articles": 25,
        "errors": 0
      },
      "rss": {
        "articles": 80,
        "errors": 0
      },
      "stocktwits": {
        "messages": 0,
        "errors": 0
      },
      "alphavantage": {
        "items": 0,
        "errors": 0
      }
    }
  }
}
```

### å­—æ®µè¯´æ˜

- `event`: äº‹ä»¶ç±»å‹ï¼ˆå›ºå®šä¸º `"crawl_complete"`ï¼‰
- `timestamp`: ISO æ ¼å¼æ—¶é—´æˆ³
- `statistics.total_items`: æœ¬æ¬¡çˆ¬å–çš„æ€»æ•°æ®é‡
- `statistics.total_errors`: æœ¬æ¬¡çˆ¬å–çš„é”™è¯¯æ•°
- `statistics.queue_length`: å½“å‰ Redis é˜Ÿåˆ—é•¿åº¦
- `statistics.by_source`: å„æ•°æ®æºçš„è¯¦ç»†ç»Ÿè®¡

## ğŸ” ç›‘æ§ä¸è°ƒè¯•

### æ£€æŸ¥é€šçŸ¥æ˜¯å¦å‘é€

ä½¿ç”¨ Redis CLI ç›‘æ§é€šçŸ¥é¢‘é“ï¼š

```bash
redis-cli
> SUBSCRIBE crawler_complete
```

ä½ ä¼šçœ‹åˆ°ï¼š
```
Reading messages... (press Ctrl-C to quit)
1) "subscribe"
2) "crawler_complete"
3) (integer) 1

1) "message"
2) "crawler_complete"
3) "{\"event\":\"crawl_complete\",\"timestamp\":\"...\",...}"
```

### æ£€æŸ¥ Cleaner æ˜¯å¦åœ¨ç›‘å¬

æŸ¥çœ‹ Cleaner çš„æ—¥å¿—ï¼š

```cmd
type cleaner\logs\event_driven_cleaner.log
```

åº”è¯¥çœ‹åˆ°ï¼š
```
[INFO] âœ“ Redis è¿æ¥æˆåŠŸ: localhost:6379
[INFO] âœ“ å·²è®¢é˜…é¢‘é“: crawler_complete
[INFO] ğŸ§ äº‹ä»¶é©±åŠ¨æ¨¡å¼å¯åŠ¨
[INFO] ç­‰å¾…çˆ¬è™«å®Œæˆé€šçŸ¥...
```

### æ‰‹åŠ¨æµ‹è¯•é€šçŸ¥

ä½¿ç”¨ Python æ‰‹åŠ¨å‘é€æµ‹è¯•é€šçŸ¥ï¼š

```python
import redis
import json

r = redis.Redis(host='localhost', port=6379, db=0, decode_responses=True)

message = {
    "event": "crawl_complete",
    "timestamp": "2025-11-01T14:00:00",
    "statistics": {
        "total_items": 100,
        "queue_length": 100
    }
}

r.publish('crawler_complete', json.dumps(message))
print("æµ‹è¯•é€šçŸ¥å·²å‘é€")
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. é¢‘é“åç§°å¿…é¡»ä¸€è‡´

ç¡®ä¿ Scraper å’Œ Cleaner é…ç½®ä¸­çš„ `channel` åç§°å®Œå…¨ç›¸åŒï¼š

```yaml
# scraper/config.yaml
notification:
  channel: "crawler_complete"

# cleaner/config_processing.yaml
notification:
  channel: "crawler_complete"  # å¿…é¡»ä¸€è‡´
```

### 2. Redis è¿æ¥

- Scraper å’Œ Cleaner å¿…é¡»è¿æ¥åˆ°åŒä¸€ä¸ª Redis å®ä¾‹
- é€šçŸ¥ä½¿ç”¨ Redis Pub/Subï¼Œä¸å ç”¨é˜Ÿåˆ—ç©ºé—´
- Pub/Sub æ¶ˆæ¯ä¸æŒä¹…åŒ–ï¼Œè®¢é˜…è€…å¿…é¡»åœ¨çº¿æ‰èƒ½æ”¶åˆ°

### 3. å¯åŠ¨é¡ºåº

**æ¨èé¡ºåº**ï¼š
1. Redis
2. Cleanerï¼ˆå…ˆå¯åŠ¨ï¼Œå¼€å§‹ç›‘å¬ï¼‰
3. Scraperï¼ˆåå¯åŠ¨ï¼Œå‘é€é€šçŸ¥ï¼‰

å¦‚æœ Scraper å…ˆå¯åŠ¨ï¼ŒCleaner ä¼šé”™è¿‡é€šçŸ¥ã€‚

### 4. å¤šä¸ª Cleaner å®ä¾‹

å¯ä»¥å¯åŠ¨å¤šä¸ª Cleaner å®ä¾‹ï¼š
- æ‰€æœ‰å®ä¾‹éƒ½ä¼šæ”¶åˆ°é€šçŸ¥
- æ¯ä¸ªå®ä¾‹ç‹¬ç«‹æ¸…æ´—æ•°æ®
- ä½¿ç”¨ `id_cache` é¿å…é‡å¤å¤„ç†

### 5. ç½‘ç»œé—®é¢˜

å¦‚æœé€šçŸ¥å¶å°”ä¸¢å¤±ï¼š
- å¢åŠ  Cleaner çš„å®¹é”™æœºåˆ¶
- æˆ–é…åˆå®šæ—¶æ£€æŸ¥é˜Ÿåˆ—é•¿åº¦
- æˆ–ä½¿ç”¨ `continuous` æ¨¡å¼ä½œä¸ºå¤‡ä»½

## ğŸ†˜ æ•…éšœæ’é™¤

### é—®é¢˜ 1: Cleaner æ²¡æœ‰æ”¶åˆ°é€šçŸ¥

**åŸå› **ï¼š
- Cleaner æœªå¯åŠ¨æˆ–å´©æºƒ
- é¢‘é“åç§°ä¸ä¸€è‡´
- Redis è¿æ¥é—®é¢˜

**è§£å†³**ï¼š
1. æ£€æŸ¥ Cleaner æ˜¯å¦åœ¨è¿è¡Œ
2. å¯¹æ¯”é…ç½®æ–‡ä»¶ä¸­çš„ `channel` åç§°
3. æµ‹è¯• Redis è¿æ¥

### é—®é¢˜ 2: é€šçŸ¥å‘é€å¤±è´¥

**ç—‡çŠ¶**ï¼š
```
ğŸ“¢ é€šçŸ¥å·²å‘é€åˆ°é¢‘é“ 'crawler_complete' (0 ä¸ªè®¢é˜…è€…)
```

**åŸå› **ï¼š
- Cleaner æœªå¯åŠ¨
- Cleaner æœªè®¢é˜…è¯¥é¢‘é“

**è§£å†³**ï¼š
å…ˆå¯åŠ¨ Cleanerï¼Œå†è¿è¡Œ Scraper

### é—®é¢˜ 3: æ¸…æ´—é‡å¤æ‰§è¡Œ

**åŸå› **ï¼š
- å¤šä¸ª Cleaner å®ä¾‹åŒæ—¶è¿è¡Œ
- é€šçŸ¥è¢«å¤šæ¬¡å‘é€

**è§£å†³**ï¼š
- åªè¿è¡Œä¸€ä¸ª Cleaner å®ä¾‹
- æˆ–ä½¿ç”¨åˆ†å¸ƒå¼é”æœºåˆ¶

### é—®é¢˜ 4: æƒ³ç¦ç”¨é€šçŸ¥åŠŸèƒ½

**è§£å†³**ï¼š

åœ¨ `scraper/config.yaml` ä¸­ï¼š
```yaml
notification:
  enabled: false
```

åœ¨ `cleaner/config_processing.yaml` ä¸­ï¼š
```yaml
notification:
  enabled: false
  mode: "continuous"  # å›é€€åˆ°æŒç»­æ¨¡å¼
```

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### æŒç»­è½®è¯¢æ¨¡å¼

- CPU ä½¿ç”¨ç‡: ~5-10%ï¼ˆæŒç»­ï¼‰
- å†…å­˜: ~50MB
- å»¶è¿Ÿ: ä½ï¼ˆ<1ç§’ï¼‰
- èµ„æºæ•ˆç‡: ä½

### äº‹ä»¶é©±åŠ¨æ¨¡å¼

- CPU ä½¿ç”¨ç‡: ~0-1%ï¼ˆç©ºé—²æ—¶ï¼‰ï¼Œ~10%ï¼ˆå·¥ä½œæ—¶ï¼‰
- å†…å­˜: ~30MB
- å»¶è¿Ÿ: ä½ï¼ˆ<1ç§’ï¼‰
- èµ„æºæ•ˆç‡: é«˜

**ç»“è®º**ï¼šäº‹ä»¶é©±åŠ¨æ¨¡å¼åœ¨ä¿æŒä½å»¶è¿Ÿçš„åŒæ—¶ï¼Œæ˜¾è‘—é™ä½äº†èµ„æºå ç”¨ã€‚

## ğŸ”„ ä¸å…¶ä»–æ¨¡å—çš„é›†æˆ

### å®Œæ•´æ•°æ®æµ

```
Scraper (5åˆ†é’Ÿ) 
    â†“ [é€šçŸ¥]
Cleaner (æŒ‰éœ€) 
    â†“ [é˜Ÿåˆ—]
Processor (60ç§’)
    â†“ [Redis DB2]
Visualization (å®æ—¶)
```

### æ—¶é—´é…ç½®åè°ƒ

- **Scraper**: 5åˆ†é’Ÿçˆ¬ä¸€æ¬¡ï¼ˆ`loop_interval: 300`ï¼‰
- **Cleaner**: æ”¶åˆ°é€šçŸ¥åæ‰§è¡Œï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰
- **Processor**: 60ç§’æ£€æŸ¥ä¸€æ¬¡ï¼ˆ`process_interval_seconds: 60`ï¼‰

### å»ºè®®é…ç½®

å¯¹äºå®æ—¶æ€§è¦æ±‚é«˜çš„åœºæ™¯ï¼š
- Scraper: 2-5åˆ†é’Ÿ
- Cleaner: äº‹ä»¶é©±åŠ¨ï¼ˆç«‹å³ï¼‰
- Processor: 30-60ç§’

å¯¹äºèµ„æºå—é™åœºæ™¯ï¼š
- Scraper: 10-15åˆ†é’Ÿ
- Cleaner: äº‹ä»¶é©±åŠ¨ï¼ˆç«‹å³ï¼‰
- Processor: 5-10åˆ†é’Ÿ

## ğŸ“š å‚è€ƒæ–‡ä»¶

- `scraper/config.yaml` - Scraper é…ç½®
- `scraper/control_center.py` - çˆ¬è™«æ§åˆ¶ä¸­å¿ƒï¼ˆå‘é€é€šçŸ¥ï¼‰
- `scraper/utils/redis_client.py` - Redis å®¢æˆ·ç«¯ï¼ˆé€šçŸ¥åŠŸèƒ½ï¼‰
- `cleaner/config_processing.yaml` - Cleaner é…ç½®
- `cleaner/data_cleaner_event_driven.py` - äº‹ä»¶é©±åŠ¨æ¸…æ´—å™¨
- `cleaner/start_cleaner.bat` - Cleaner å¯åŠ¨è„šæœ¬

## ğŸ“ æ‰©å±•é˜…è¯»

### Redis Pub/Sub æœºåˆ¶

- è½»é‡çº§æ¶ˆæ¯ä¼ é€’
- æ— æŒä¹…åŒ–ï¼ˆè®¢é˜…è€…å¿…é¡»åœ¨çº¿ï¼‰
- æ”¯æŒæ¨¡å¼åŒ¹é…è®¢é˜…
- é€‚åˆå®æ—¶é€šçŸ¥åœºæ™¯

### æ›¿ä»£æ–¹æ¡ˆ

å¦‚æœéœ€è¦æŒä¹…åŒ–é€šçŸ¥ï¼š
1. ä½¿ç”¨ Redis Streams
2. ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRabbitMQ, Kafkaï¼‰
3. ä½¿ç”¨æ•°æ®åº“è½®è¯¢ + çŠ¶æ€æ ‡è®°
