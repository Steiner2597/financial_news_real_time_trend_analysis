# äº‹ä»¶é©±åŠ¨æ¸…æ´—å™¨æ¨¡å—è¯´æ˜

## ğŸ“ ç›®å½•ç»“æ„

```
cleaner/
â”œâ”€â”€ event_driven/                    # äº‹ä»¶é©±åŠ¨æ¨¡å—ï¼ˆæ–°ï¼‰
â”‚   â”œâ”€â”€ __init__.py                 # æ¨¡å—åˆå§‹åŒ–
â”‚   â”œâ”€â”€ cleaner.py                  # ä¸»æ¸…æ´—å™¨ç±»
â”‚   â”œâ”€â”€ redis_manager.py            # Redis è¿æ¥ç®¡ç†
â”‚   â”œâ”€â”€ notification_handler.py     # æ¶ˆæ¯é€šçŸ¥å¤„ç†
â”‚   â”œâ”€â”€ cache_manager.py            # ID ç¼“å­˜ç®¡ç†
â”‚   â””â”€â”€ signal_handler.py           # ä¿¡å·å¤„ç†
â”‚
â”œâ”€â”€ data_cleaner_event_driven_v2.py # æ–°å…¥å£æ–‡ä»¶ï¼ˆä½¿ç”¨æ¨¡å—åŒ–ç‰ˆæœ¬ï¼‰
â”œâ”€â”€ data_cleaner_module.py          # æ ¸å¿ƒæ¸…æ´—é€»è¾‘
â””â”€â”€ config_processing.yaml          # é…ç½®æ–‡ä»¶
```

## ğŸ“¦ æ¨¡å—èŒè´£

### 1. **cleaner.py** - ä¸»æ¸…æ´—å™¨ç±»
- **èŒè´£**: æ•´åˆæ‰€æœ‰ç»„ä»¶ï¼Œæä¾›å®Œæ•´çš„äº‹ä»¶é©±åŠ¨æ¸…æ´—åŠŸèƒ½
- **ä¸»è¦ç±»**: `EventDrivenCleaner`
- **æ ¸å¿ƒæ–¹æ³•**:
  - `__init__()`: åˆå§‹åŒ–æ‰€æœ‰ç»„ä»¶
  - `run()`: æ ¹æ®é…ç½®è¿è¡Œï¼ˆäº‹ä»¶é©±åŠ¨/æŒç»­æ¨¡å¼ï¼‰
  - `run_event_driven()`: äº‹ä»¶é©±åŠ¨æ¨¡å¼ä¸»å¾ªç¯
  - `run_continuous()`: æŒç»­è½®è¯¢æ¨¡å¼
  - `_process_notification()`: å¤„ç†æ”¶åˆ°çš„é€šçŸ¥
  - `_run_cleaning()`: æ‰§è¡Œå®é™…æ¸…æ´—ä»»åŠ¡

### 2. **redis_manager.py** - Redis è¿æ¥ç®¡ç†å™¨
- **èŒè´£**: ç®¡ç† Redis çš„è®¢é˜…å’Œå‘å¸ƒè¿æ¥
- **ä¸»è¦ç±»**: `RedisConnectionManager`
- **æ ¸å¿ƒæ–¹æ³•**:
  - `connect_subscribe()`: åˆ›å»ºè®¢é˜…è¿æ¥
  - `connect_publish()`: åˆ›å»ºå‘å¸ƒè¿æ¥
  - `cleanup()`: æ¸…ç†æ‰€æœ‰è¿æ¥ï¼ˆå¿«é€Ÿå…³é—­ï¼‰

### 3. **notification_handler.py** - æ¶ˆæ¯é€šçŸ¥å¤„ç†å™¨
- **èŒè´£**: å¤„ç†æ¥æ”¶å’Œå‘é€ Redis Pub/Sub æ¶ˆæ¯
- **ä¸»è¦ç±»**: `NotificationHandler`
- **æ ¸å¿ƒæ–¹æ³•**:
  - `parse_message()`: è§£ææ”¶åˆ°çš„æ¶ˆæ¯
  - `log_received_message()`: è®°å½•æ¶ˆæ¯å†…å®¹
  - `send_completion_notification()`: å‘é€æ¸…æ´—å®Œæˆé€šçŸ¥
  - `process_message()`: å¤„ç†æ¶ˆæ¯å¹¶æ‰§è¡Œæ¸…æ´—

### 4. **cache_manager.py** - ID ç¼“å­˜ç®¡ç†å™¨
- **èŒè´£**: ç®¡ç†å»é‡ ID ç¼“å­˜çš„çŠ¶æ€å’Œæ“ä½œ
- **ä¸»è¦ç±»**: `CacheManager`
- **æ ¸å¿ƒæ–¹æ³•**:
  - `clear_cache()`: æ¸…ç©º ID ç¼“å­˜
  - `get_cache_status()`: è·å–ç¼“å­˜çŠ¶æ€
  - `log_cache_status()`: è®°å½•ç¼“å­˜çŠ¶æ€åˆ°æ—¥å¿—

### 5. **signal_handler.py** - ä¿¡å·å¤„ç†å™¨
- **èŒè´£**: å¤„ç†ç¨‹åºé€€å‡ºä¿¡å·ï¼ˆSIGINT, SIGTERMï¼‰
- **ä¸»è¦ç±»**: `SignalHandler`
- **æ ¸å¿ƒæ–¹æ³•**:
  - `setup()`: è®¾ç½®ä¿¡å·å¤„ç†
  - `restore()`: æ¢å¤åŸå§‹ä¿¡å·å¤„ç†å™¨
  - `_signal_handler()`: å¤„ç†é€€å‡ºä¿¡å·

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### ä½¿ç”¨æ–¹æ³•

```bash
# è¿›å…¥ cleaner ç›®å½•
cd cleaner

# æ–¹å¼ 1: ç›´æ¥è¿è¡Œ
python data_cleaner_event_driven.py

# æ–¹å¼ 2: ä½¿ç”¨å¯åŠ¨è„šæœ¬
start_cleaner.bat

# æŒ‡å®šè¿è¡Œæ¨¡å¼
python data_cleaner_event_driven.py --mode event_driven   # äº‹ä»¶é©±åŠ¨æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
python data_cleaner_event_driven.py --mode continuous     # æŒç»­è½®è¯¢æ¨¡å¼
python data_cleaner_event_driven.py --mode once          # å•æ¬¡è¿è¡Œæ¨¡å¼
```

## ğŸ”§ é…ç½®æ–‡ä»¶

é…ç½®æ–‡ä»¶ `config_processing.yaml` ä¿æŒä¸å˜ï¼š

```yaml
redis:
  host: "localhost"
  port: 6379
  db_in: 0          # è¾“å…¥æ•°æ®åº“ï¼ˆä» Scraper è¯»å–ï¼‰
  db_out: 1         # è¾“å‡ºæ•°æ®åº“ï¼ˆå‘é€ç»™ Processorï¼‰
  data_queue: "data_queue"              # è¾“å…¥é˜Ÿåˆ—
  clean_data_queue: "clean_data_queue"  # è¾“å‡ºé˜Ÿåˆ—
  id_cache: "cleaned_ids"               # ID ç¼“å­˜
  
  notification_listen:
    enabled: true
    channel: "crawler_complete"
    mode: "event_driven"
  
  notification_send:
    enabled: true
    channel: "cleaner_complete"

deduplication:
  mode: "time_window"  # æˆ– "permanent"
  window_hours: 24
  clear_on_start: false
```

## âœ¨ æ”¹è¿›ç‚¹

### 1. **ä»£ç ç»„ç»‡**
- âœ… å•ä¸€èŒè´£åŸåˆ™ï¼šæ¯ä¸ªæ¨¡å—è´Ÿè´£ä¸€ä¸ªæ˜ç¡®çš„åŠŸèƒ½
- âœ… ä½è€¦åˆï¼šæ¨¡å—ä¹‹é—´é€šè¿‡æ¥å£é€šä¿¡
- âœ… é«˜å†…èšï¼šç›¸å…³åŠŸèƒ½é›†ä¸­åœ¨åŒä¸€æ¨¡å—

### 2. **å¯ç»´æŠ¤æ€§**
- âœ… ä»£ç æ›´æ¸…æ™°ï¼Œæ˜“äºç†è§£
- âœ… ä¾¿äºå•ç‹¬æµ‹è¯•æ¯ä¸ªæ¨¡å—
- âœ… æ˜“äºæ‰©å±•æ–°åŠŸèƒ½

### 3. **æ€§èƒ½ä¼˜åŒ–**
- âœ… Redis è¿æ¥å¿«é€Ÿå…³é—­ï¼ˆä¸é˜»å¡ï¼‰
- âœ… ä¼˜åŒ–çš„ä¿¡å·å¤„ç†
- âœ… æ›´å¥½çš„èµ„æºç®¡ç†
- âœ… **å•æ¬¡æ¸…æ´—æ¨¡å¼**ï¼šæ”¶åˆ°é€šçŸ¥â†’æ¸…æ´—â†’å®Œæˆâ†’ç»§ç»­å¾…å‘½ï¼ˆä¸é˜»å¡ï¼‰

### 4. **é”™è¯¯å¤„ç†**
- âœ… æ¯ä¸ªæ¨¡å—ç‹¬ç«‹çš„é”™è¯¯å¤„ç†
- âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•
- âœ… ä¼˜é›…çš„å…³é—­æµç¨‹

### 5. **å·¥ä½œæµç¨‹ä¼˜åŒ–** â­ æ–°å¢
- âœ… **éé˜»å¡æ¸…æ´—**ï¼šæ¸…æ´—å®Œæˆåç«‹å³è¿”å›ï¼Œä¸ä¼šå¡åœ¨æ¸…æ´—å¾ªç¯
- âœ… **æ˜ç¡®çš„å¤„ç†è¾¹ç•Œ**ï¼šåªå¤„ç†å½“å‰é˜Ÿåˆ—ä¸­çš„æ•°æ®
- âœ… **å¿«é€Ÿå“åº”**ï¼šæ”¶åˆ°é€šçŸ¥åç«‹å³å¤„ç†ï¼Œå¤„ç†å®Œç«‹å³é€šçŸ¥ä¸‹æ¸¸
- âœ… **æ‰¹é‡ä¼˜åŒ–**ï¼šæ”¯æŒæ‰¹é‡å¤„ç†ï¼Œå‡å°‘ Redis æ“ä½œæ¬¡æ•°

## ğŸ“ è¿ç§»æŒ‡å—

### ä»æ—§ç‰ˆæœ¬è¿ç§»åˆ°æ–°ç‰ˆæœ¬

1. **æ— éœ€ä¿®æ”¹é…ç½®æ–‡ä»¶** - é…ç½®æ–‡ä»¶å®Œå…¨å…¼å®¹
2. **æ›´æ–°å¯åŠ¨è„šæœ¬** - å°† `data_cleaner_event_driven.py` æ”¹ä¸º `data_cleaner_event_driven_v2.py`
3. **æµ‹è¯•è¿è¡Œ** - åŠŸèƒ½å®Œå…¨ä¸€è‡´ï¼Œåªæ˜¯å†…éƒ¨ç»“æ„æ›´æ¸…æ™°

### è‡ªå®šä¹‰æ‰©å±•

å¦‚æœéœ€è¦è‡ªå®šä¹‰åŠŸèƒ½ï¼Œç°åœ¨å¯ä»¥ï¼š

1. **æ‰©å±•ç¼“å­˜ç®¡ç†**: ä¿®æ”¹ `cache_manager.py`
2. **è‡ªå®šä¹‰é€šçŸ¥**: ä¿®æ”¹ `notification_handler.py`
3. **æ·»åŠ æ–°çš„è¿æ¥ç±»å‹**: ä¿®æ”¹ `redis_manager.py`

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šå…³é—­æ—¶é—´è¿‡é•¿

**è§£å†³æ–¹æ¡ˆ**: æ–°ç‰ˆæœ¬å·²ä¼˜åŒ–å…³é—­æµç¨‹
- Redis è¿æ¥å¼ºåˆ¶æ–­å¼€ï¼ˆä¸ç­‰å¾…ï¼‰
- ä¿¡å·å¤„ç†ç«‹å³å“åº”
- é¢„æœŸå…³é—­æ—¶é—´ï¼š< 2 ç§’

### é—®é¢˜ï¼šæ¨¡å—å¯¼å…¥é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**: ç¡®ä¿åœ¨ `cleaner/` ç›®å½•ä¸‹è¿è¡Œ
```bash
cd cleaner
python data_cleaner_event_driven_v2.py
```

### é—®é¢˜ï¼šæ‰¾ä¸åˆ°é…ç½®æ–‡ä»¶

**è§£å†³æ–¹æ¡ˆ**: é…ç½®æ–‡ä»¶åº”åœ¨ `cleaner/` ç›®å½•ä¸‹
```bash
cleaner/
â”œâ”€â”€ config_processing.yaml  # ç¡®ä¿å­˜åœ¨
â””â”€â”€ data_cleaner_event_driven_v2.py
```

## ğŸ“š è¿›ä¸€æ­¥é˜…è¯»

- [Redis Pub/Sub æ–‡æ¡£](https://redis.io/docs/manual/pubsub/)
- [Python ä¿¡å·å¤„ç†](https://docs.python.org/3/library/signal.html)
- [å•ä¸€èŒè´£åŸåˆ™](https://en.wikipedia.org/wiki/Single-responsibility_principle)
