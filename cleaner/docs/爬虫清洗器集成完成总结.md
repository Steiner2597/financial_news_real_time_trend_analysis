# çˆ¬è™«-æ¸…æ´—å™¨é›†æˆå®Œæˆæ€»ç»“

## âœ… å®Œæˆå†…å®¹

### 1. æ·»åŠ äº† Redis Pub/Sub é€šçŸ¥æœºåˆ¶

#### Scraper ç«¯
- âœ… ä¿®æ”¹ `config.yaml`ï¼Œæ·»åŠ  `notification` é…ç½®
- âœ… ä¿®æ”¹ `utils/redis_client.py`ï¼Œæ·»åŠ  `publish_notification()` æ–¹æ³•
- âœ… ä¿®æ”¹ `control_center.py`ï¼Œæ·»åŠ  `_send_completion_notification()` æ–¹æ³•
- âœ… åœ¨ `run_all_crawlers()` å®Œæˆåè‡ªåŠ¨å‘é€é€šçŸ¥

#### Cleaner ç«¯
- âœ… ä¿®æ”¹ `config_processing.yaml`ï¼Œæ·»åŠ  `notification` é…ç½®
- âœ… åˆ›å»º `data_cleaner_event_driven.py`ï¼Œå®ç°äº‹ä»¶é©±åŠ¨æ¸…æ´—å™¨
- âœ… æ”¯æŒä¸‰ç§è¿è¡Œæ¨¡å¼ï¼š`event_driven`ã€`continuous`ã€`once`
- âœ… åˆ›å»º `start_cleaner.bat` å¯åŠ¨è„šæœ¬
- âœ… åˆ›å»º `run_once_clean.bat` å•æ¬¡è¿è¡Œè„šæœ¬

### 2. æ–‡æ¡£å’Œæµ‹è¯•å·¥å…·

- âœ… åˆ›å»º `çˆ¬è™«æ¸…æ´—å™¨äº‹ä»¶é©±åŠ¨é›†æˆè¯´æ˜.md` è¯¦ç»†æ–‡æ¡£
- âœ… åˆ›å»º `test_notification.py` æµ‹è¯•è„šæœ¬
- âœ… åˆ›å»º `start_all_event_driven.bat` ä¸€é”®å¯åŠ¨è„šæœ¬

## ğŸ¯ å·¥ä½œåŸç†

### æ•°æ®æµ

```
1. Scraper çˆ¬å–æ•°æ®
   â†“
2. æ•°æ®å†™å…¥ Redis Queue (data_queue)
   â†“
3. Scraper å®Œæˆåå‘é€é€šçŸ¥åˆ° Redis Pub/Sub
   â†“
4. Cleaner æ”¶åˆ°é€šçŸ¥
   â†“
5. Cleaner ä» Queue è¯»å–æ•°æ®å¹¶æ¸…æ´—
   â†“
6. æ¸…æ´—ç»“æœå†™å…¥ Redis Queue (clean_data_queue)
   â†“
7. Processor ä»é˜Ÿåˆ—è¯»å–å¹¶å¤„ç†
```

### é€šçŸ¥æ¶ˆæ¯æ ¼å¼

```json
{
  "event": "crawl_complete",
  "timestamp": "2025-11-01T14:00:30",
  "statistics": {
    "total_items": 255,
    "total_errors": 0,
    "queue_length": 255,
    "by_source": {
      "reddit": {"posts": 50, "comments": 100, "errors": 0},
      "newsapi": {"articles": 25, "errors": 0},
      "rss": {"articles": 80, "errors": 0}
    }
  }
}
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹æ³• 1: ä¸€é”®å¯åŠ¨ï¼ˆæ¨èï¼‰

```cmd
start_all_event_driven.bat
```

è¿™ä¼šä¾æ¬¡å¯åŠ¨ï¼š
1. Redis
2. Cleanerï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰
3. Scraperï¼ˆå¾ªç¯æ¨¡å¼ï¼‰
4. Processorï¼ˆæŒç»­å¤„ç†ï¼‰

### æ–¹æ³• 2: æ‰‹åŠ¨å¯åŠ¨

```cmd
# 1. å¯åŠ¨ Redis
cd scraper
start_redis.bat

# 2. å¯åŠ¨ Cleanerï¼ˆæ–°çª—å£ï¼‰
cd cleaner
start_cleaner.bat

# 3. å¯åŠ¨ Scraperï¼ˆæ–°çª—å£ï¼‰
cd scraper
python control_center.py --loop

# 4. å¯åŠ¨ Processorï¼ˆæ–°çª—å£ï¼‰
cd processer
start_processor.bat
```

### æ–¹æ³• 3: æµ‹è¯•é€šçŸ¥æœºåˆ¶

```cmd
# 1. å¯åŠ¨ Redis
cd scraper
start_redis.bat

# 2. å¯åŠ¨ Cleanerï¼ˆæ–°çª—å£ï¼‰
cd cleaner
start_cleaner.bat

# 3. å‘é€æµ‹è¯•é€šçŸ¥
python test_notification.py
```

## ğŸ“Š è¿è¡Œæ¨¡å¼å¯¹æ¯”

| æ¨¡å¼ | å¯åŠ¨æ–¹å¼ | è§¦å‘æ¡ä»¶ | èµ„æºå ç”¨ | é€‚ç”¨åœºæ™¯ |
|------|---------|---------|---------|---------|
| Event-Driven | `start_cleaner.bat` | æ”¶åˆ°é€šçŸ¥ | ä½ï¼ˆç©ºé—²æ—¶ï¼‰ | **ç”Ÿäº§ç¯å¢ƒï¼ˆæ¨èï¼‰** |
| Continuous | `--mode continuous` | æŒç»­è½®è¯¢ | ä¸­ç­‰ï¼ˆæŒç»­ï¼‰ | æ—§ç³»ç»Ÿå…¼å®¹ |
| Once | `run_once_clean.bat` | æ‰‹åŠ¨æ‰§è¡Œ | ä½ï¼ˆæ‰§è¡Œå®Œé€€å‡ºï¼‰ | æµ‹è¯•/è°ƒè¯• |

## âš™ï¸ é…ç½®å‚æ•°

### Scraper (`scraper/config.yaml`)

```yaml
redis:
  notification:
    enabled: true              # æ˜¯å¦å‘é€é€šçŸ¥
    channel: "crawler_complete"  # é€šçŸ¥é¢‘é“
```

### Cleaner (`cleaner/config_processing.yaml`)

```yaml
redis:
  notification:
    enabled: true              # æ˜¯å¦å¯ç”¨äº‹ä»¶é©±åŠ¨
    channel: "crawler_complete"  # ç›‘å¬é¢‘é“ï¼ˆå¿…é¡»ä¸ Scraper ä¸€è‡´ï¼‰
    mode: "event_driven"       # è¿è¡Œæ¨¡å¼
```

## ğŸ” ç›‘æ§ä¸è°ƒè¯•

### 1. æŸ¥çœ‹é€šçŸ¥æ˜¯å¦å‘é€

Scraper æ—¥å¿—ä¼šæ˜¾ç¤ºï¼š
```
ğŸ“¢ é€šçŸ¥å·²å‘é€åˆ°é¢‘é“ 'crawler_complete' (1 ä¸ªè®¢é˜…è€…)
```

### 2. æŸ¥çœ‹é€šçŸ¥æ˜¯å¦æ”¶åˆ°

Cleaner æ—¥å¿—ä¼šæ˜¾ç¤ºï¼š
```
====================================================================
ğŸ“¬ æ”¶åˆ°çˆ¬è™«å®Œæˆé€šçŸ¥
====================================================================
äº‹ä»¶ç±»å‹: crawl_complete
æ—¶é—´æˆ³: 2025-11-01T14:00:30
æ€»æ•°æ®é‡: 255
é˜Ÿåˆ—é•¿åº¦: 255
```

### 3. æ‰‹åŠ¨ç›‘æ§é€šçŸ¥é¢‘é“

```cmd
redis-cli
> SUBSCRIBE crawler_complete
```

### 4. æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶

```cmd
# Cleaner æ—¥å¿—
type cleaner\logs\event_driven_cleaner.log

# Scraper æ—¥å¿—
type scraper\logs\control_center.log
```

## ğŸ“ˆ æ€§èƒ½æ”¹è¿›

### ä¹‹å‰ï¼ˆæŒç»­è½®è¯¢ï¼‰
- CPU: ~5-10%ï¼ˆæŒç»­ï¼‰
- å†…å­˜: ~50MB
- å“åº”å»¶è¿Ÿ: <1ç§’
- èµ„æºæ•ˆç‡: âŒ ä½

### ç°åœ¨ï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰
- CPU: ~0-1%ï¼ˆç©ºé—²ï¼‰ï¼Œ~10%ï¼ˆå·¥ä½œæ—¶ï¼‰
- å†…å­˜: ~30MB
- å“åº”å»¶è¿Ÿ: <1ç§’
- èµ„æºæ•ˆç‡: âœ… é«˜

**æ”¹è¿›**ï¼š
- CPU ç©ºé—²æ—¶é™ä½ 80-90%
- å†…å­˜é™ä½ 40%
- å“åº”é€Ÿåº¦ä¿æŒä¸å˜

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. é¢‘é“åç§°å¿…é¡»ä¸€è‡´
Scraper å’Œ Cleaner çš„ `channel` å¿…é¡»å®Œå…¨ç›¸åŒ

### 2. å¯åŠ¨é¡ºåºå¾ˆé‡è¦
**æ¨èé¡ºåº**ï¼šRedis â†’ Cleaner â†’ Scraper â†’ Processor

å¦‚æœ Scraper å…ˆå¯åŠ¨ï¼ŒCleaner ä¼šé”™è¿‡ç¬¬ä¸€æ¬¡é€šçŸ¥

### 3. Redis Pub/Sub ç‰¹ç‚¹
- âœ… è½»é‡çº§ï¼Œå®æ—¶æ€§å¥½
- âŒ ä¸æŒä¹…åŒ–ï¼Œè®¢é˜…è€…å¿…é¡»åœ¨çº¿
- âŒ æ¶ˆæ¯ä¸¢å¤±åæ— æ³•æ‰¾å›

### 4. ç¦ç”¨é€šçŸ¥åŠŸèƒ½
å¦‚æœæƒ³å›é€€åˆ°æ—§æ¨¡å¼ï¼Œè®¾ç½®ï¼š
```yaml
notification:
  enabled: false
  mode: "continuous"
```

## ğŸ†˜ æ•…éšœæ’é™¤

### é—®é¢˜ 1: Cleaner æ²¡æ”¶åˆ°é€šçŸ¥

**æ£€æŸ¥**ï¼š
1. Cleaner æ˜¯å¦å·²å¯åŠ¨ï¼Ÿ
2. é¢‘é“åç§°æ˜¯å¦ä¸€è‡´ï¼Ÿ
3. Redis è¿æ¥æ˜¯å¦æ­£å¸¸ï¼Ÿ

**æµ‹è¯•**ï¼š
```cmd
python test_notification.py
```

### é—®é¢˜ 2: é€šçŸ¥æ˜¾ç¤º 0 ä¸ªè®¢é˜…è€…

**åŸå› **ï¼šCleaner æœªå¯åŠ¨æˆ–æœªè®¢é˜…

**è§£å†³**ï¼šå…ˆå¯åŠ¨ Cleanerï¼Œå†è¿è¡Œ Scraper

### é—®é¢˜ 3: æ¸…æ´—å™¨é‡å¤è¿è¡Œ

**åŸå› **ï¼šå¯åŠ¨äº†å¤šä¸ª Cleaner å®ä¾‹

**è§£å†³**ï¼šåªä¿ç•™ä¸€ä¸ª Cleaner è¿›ç¨‹

## ğŸ“ æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶

### æ–°å¢æ–‡ä»¶
- `cleaner/data_cleaner_event_driven.py` - äº‹ä»¶é©±åŠ¨æ¸…æ´—å™¨
- `cleaner/start_cleaner.bat` - æ¸…æ´—å™¨å¯åŠ¨è„šæœ¬
- `cleaner/run_once_clean.bat` - å•æ¬¡è¿è¡Œè„šæœ¬
- `çˆ¬è™«æ¸…æ´—å™¨äº‹ä»¶é©±åŠ¨é›†æˆè¯´æ˜.md` - è¯¦ç»†æ–‡æ¡£
- `test_notification.py` - æµ‹è¯•è„šæœ¬
- `start_all_event_driven.bat` - ä¸€é”®å¯åŠ¨è„šæœ¬
- `æœ¬æ–‡ä»¶` - å®Œæˆæ€»ç»“

### ä¿®æ”¹æ–‡ä»¶
- `scraper/config.yaml` - æ·»åŠ  notification é…ç½®
- `scraper/utils/redis_client.py` - æ·»åŠ  publish_notification æ–¹æ³•
- `scraper/control_center.py` - æ·»åŠ å‘é€é€šçŸ¥é€»è¾‘
- `cleaner/config_processing.yaml` - æ·»åŠ  notification é…ç½®

## ğŸ”„ ä¸å…¶ä»–é…ç½®çš„åè°ƒ

### å½“å‰æ—¶é—´é…ç½®
- **Scraper**: æ¯ 5 åˆ†é’Ÿçˆ¬å–ä¸€æ¬¡
- **Cleaner**: æ”¶åˆ°é€šçŸ¥ç«‹å³æ‰§è¡Œ
- **Processor**: æ¯ 60 ç§’å¤„ç†ä¸€æ¬¡

### æ•°æ®æµæ—¶åº
```
0:00 - Scraper å¼€å§‹çˆ¬å–
0:05 - Scraper å®Œæˆ â†’ å‘é€é€šçŸ¥ â†’ Cleaner å¼€å§‹æ¸…æ´—
0:06 - Cleaner å®Œæˆ
0:07 - Processor å¤„ç†ï¼ˆä¸‹ä¸ªå‘¨æœŸï¼‰
```

## ğŸ“ æŠ€æœ¯è¦ç‚¹

### Redis Pub/Sub
- å‘å¸ƒè€…ï¼šScraper (`PUBLISH crawler_complete`)
- è®¢é˜…è€…ï¼šCleaner (`SUBSCRIBE crawler_complete`)
- æ¶ˆæ¯æ ¼å¼ï¼šJSON
- ç‰¹ç‚¹ï¼šå®æ—¶ã€è½»é‡ã€ä¸æŒä¹…åŒ–

### Python ä¿¡å·å¤„ç†
- `SIGINT`ï¼šCtrl+C ä¼˜é›…é€€å‡º
- `SIGTERM`ï¼šç³»ç»Ÿç»ˆæ­¢ä¿¡å·
- ç¡®ä¿èµ„æºæ­£ç¡®æ¸…ç†

### å¤šè¿›ç¨‹åä½œ
- Scraperã€Cleanerã€Processor å„è‡ªç‹¬ç«‹è¿è¡Œ
- é€šè¿‡ Redis è¿›è¡Œæ•°æ®ä¼ é€’å’Œäº‹ä»¶é€šçŸ¥
- æ¾è€¦åˆè®¾è®¡ï¼Œæ˜“äºæ‰©å±•

## ğŸ“š å‚è€ƒæ–‡æ¡£

è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·æŸ¥çœ‹ï¼š
- `çˆ¬è™«æ¸…æ´—å™¨äº‹ä»¶é©±åŠ¨é›†æˆè¯´æ˜.md` - å®Œæ•´æ–‡æ¡£
- `scraper/çˆ¬è™«æ—¶é—´é…ç½®è¯´æ˜.md` - çˆ¬è™«æ—¶é—´é…ç½®
- `processer/æŒç»­å¤„ç†å™¨ä½¿ç”¨æŒ‡å—.md` - å¤„ç†å™¨é…ç½®

## ğŸ‰ æ€»ç»“

é€šè¿‡å¼•å…¥äº‹ä»¶é©±åŠ¨æœºåˆ¶ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

1. âœ… **æ›´é«˜æ•ˆçš„èµ„æºåˆ©ç”¨**ï¼šCleaner æŒ‰éœ€è¿è¡Œï¼Œä¸å†ç©ºè½¬
2. âœ… **æ›´æ¸…æ™°çš„æ•°æ®æµ**ï¼šé€šè¿‡é€šçŸ¥æ˜ç¡®å„æ¨¡å—çš„æ‰§è¡Œæ—¶æœº
3. âœ… **æ›´å¥½çš„å¯ç›‘æ§æ€§**ï¼šé€šçŸ¥æ¶ˆæ¯åŒ…å«è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯
4. âœ… **ä¿æŒå…¼å®¹æ€§**ï¼šä»æ”¯æŒæ—§çš„æŒç»­è½®è¯¢æ¨¡å¼
5. âœ… **æ˜“äºæ‰©å±•**ï¼šå¯ä»¥è½»æ¾æ·»åŠ æ›´å¤šè®¢é˜…è€…

è¿™ä¸ªæ”¹è¿›ä½¿å¾—æ•´ä¸ªæ•°æ®ç®¡é“æ›´åŠ ç°ä»£åŒ–ã€é«˜æ•ˆå’Œå¯ç»´æŠ¤ï¼
