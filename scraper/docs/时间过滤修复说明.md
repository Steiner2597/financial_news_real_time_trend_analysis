# ⏰ 时间过滤修复 - 避免抓到旧数据

## 🐛 问题描述
批量爬虫使用 `subreddit.new()` 和 `subreddit.rising()` 时，会抓到几天甚至几周前的旧帖子。

**原因**：
- `subreddit.new()` 返回"最新"的帖子，但对于不活跃的子版块，"最新"可能是几天前
- `subreddit.rising()` 返回"上升中"的帖子，但旧帖子被重新顶起来也会出现在 rising 中
- 这两个 API **没有时间过滤参数**

## ✅ 解决方案

### 1️⃣ 添加时间窗口过滤
在 `config.yaml` 中添加：
```yaml
reddit:
  max_post_age_hours: 24  # 只抓取最近 24 小时内的帖子
```

**推荐值**：
- `12` - 只要最新的（可能漏掉一些）
- `24` - 平衡（推荐）✅
- `48` - 宽松一些

### 2️⃣ 修改代码
添加时间检查方法：
```python
def _is_post_too_old(self, submission) -> bool:
    """检查帖子是否超过时间窗口"""
    post_time = datetime.fromtimestamp(submission.created_utc)
    now = datetime.now()
    age_hours = (now - post_time).total_seconds() / 3600
    
    if age_hours > self.max_post_age_hours:
        return True  # 太旧，跳过
    return False
```

在三个地方应用：
1. `_crawl_rising_posts()` - Rising 帖子
2. `crawl()` 的 `new()` 循环 - New 帖子
3. `_crawl_search_keywords()` - 搜索结果

### 3️⃣ 日志优化
现在会显示帖子的发布时间：
```
📊 [批量] [1/50] Bitcoin hits new high... (2.3h前)
📊 [批量] [2/50] ETH analysis... (5.7h前)
⏰ 已过滤 12 条超过 24 小时的旧帖子
```

## 📊 效果对比

### 修复前：
```
抓取到的数据：
- 2小时前的帖子 ✅
- 1天前的帖子 ❌
- 3天前的帖子 ❌
- 1周前的帖子 ❌
```

### 修复后（max_post_age_hours: 24）：
```
抓取到的数据：
- 2小时前的帖子 ✅
- 1天前的帖子 ✅（在24小时内）
- 3天前的帖子 ❌（被过滤）
- 1周前的帖子 ❌（被过滤）
```

## 🔍 调试方法

如果想看被过滤了多少旧帖子，将日志级别改为 DEBUG：
```python
# utils/logger.py
logger.setLevel(logging.DEBUG)
```

会看到：
```
⏭️ 跳过旧帖子: Old news from last week... (发布于 5.2天前)
⏭️ 跳过旧帖子: Another old post... (发布于 2.8天前)
```

## ⚙️ 配置建议

### 场景 1: 只要最新的（金融快讯）
```yaml
max_post_age_hours: 6  # 只抓 6 小时内的
stream_enabled: true   # 配合实时流
```

### 场景 2: 平衡覆盖（推荐）
```yaml
max_post_age_hours: 24  # 抓 24 小时内的
stream_enabled: true    # 实时流捕获 < 1min 的
```

### 场景 3: 宽松抓取（历史分析）
```yaml
max_post_age_hours: 72  # 抓 3 天内的
stream_enabled: false   # 不需要实时
```

## 🎯 最佳实践

**推荐配置**（边爬边洗边处理）：
```yaml
reddit:
  enabled: true
  stream_enabled: true
  max_post_age_hours: 24
  posts_limit: 50
```

**效果**：
- 🔴 实时流：捕获 < 1分钟的新帖子
- 📊 批量爬虫：补充 1-24小时的帖子
- ⏰ 时间过滤：自动过滤 > 24小时的旧帖子
- 🛡️ 去重保护：Redis + 内存 + 清洗器三重去重

## ✅ 验证方法

运行后检查日志：
```bash
cd scraper
python control_center.py
# 选择 3 (循环模式)

# 观察日志：
# ✅ 看到 "(2.3h前)" "(15m前)" → 都是新数据
# ✅ 看到 "⏰ 已过滤 X 条超过 24 小时的旧帖子" → 过滤正常
# ❌ 看到 "(3.5d前)" → 配置没生效，检查 config.yaml
```

---

**修复完成时间**: 2025-11-03  
**核心改进**: 添加 `max_post_age_hours` 参数 + 时间检查逻辑
