# 类型冲突错误修复

## 🐛 错误信息

```
redis.exceptions.ResponseError: WRONGTYPE Operation against a key holding the wrong kind of value
```

## 🔍 原因

- **旧缓存类型**: SET (permanent 模式)
- **新代码期望**: ZSET (time_window 模式)
- **冲突**: Redis 不允许对错误类型执行操作

## ✅ 解决方案

### 方案 1：自动修复（已实现）

代码已更新，会自动检测并转换类型：

1. **重启 Cleaner**：
   ```cmd
   cd cleaner
   start_cleaner.bat
   ```

2. **首次运行会看到**：
   ```
   [WARNING] 检测到旧的 SET 类型缓存，正在转换为 ZSET...
   [INFO] 已清空旧缓存，将使用新的时间窗口模式
   ```

3. **自动完成**，之后正常运行

### 方案 2：手动清空

如果自动转换失败，手动清空：

```cmd
python clear_id_cache.py
# 输入 yes 确认
```

然后重启 Cleaner。

## 📊 验证修复

重启后应该看到：

```
======================================================================
事件驱动清洗器初始化
======================================================================
去重模式: time_window
时间窗口: 24 小时
======================================================================

📊 ID 缓存状态 (清洗前):
  类型: ZSET (时间窗口模式)  ✅ 正确类型
  总 ID 数: 0
```

## 🎯 现在就修复

1. **停止当前 Cleaner** (Ctrl+C)
2. **运行**: `python clear_id_cache.py`
3. **输入**: `yes`
4. **重启**: `cd cleaner && start_cleaner.bat`

搞定！🎉
