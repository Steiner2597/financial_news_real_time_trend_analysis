# ğŸ”§ Reddit å®æ—¶æµé›†æˆé”™è¯¯ä¿®å¤æŠ¥å‘Š

## ğŸ“… ä¿®å¤æ—¶é—´
2025-01-XX

## ğŸ” å‘ç°çš„é—®é¢˜

### 1. âš ï¸ **ç«æ€æ¡ä»¶é—®é¢˜** (å·²ä¿®å¤)
**ä½ç½®**: `control_center.py::stop_stream_monitoring()` + `reddit_stream_crawler.py::stream_submissions()`

**é—®é¢˜æè¿°**:
- `stop_stream_monitoring()` è®¾ç½® `self.stream_enabled = False`
- ä½† `stream_submissions()` ä¸­çš„ `for submission in subreddit.stream.submissions()` æ˜¯**é˜»å¡å¼è¿­ä»£å™¨**
- å½“ `duration_seconds=None` æ—¶æ— æ³•ä¼˜é›…ä¸­æ–­ï¼Œéœ€è¦ç­‰å¾…ä¸‹ä¸€æ¬¡è¿­ä»£æ‰èƒ½é€€å‡º
- å¯èƒ½å¯¼è‡´åœæ­¢å»¶è¿Ÿ 10-60 ç§’ï¼ˆå–å†³äºå¸–å­å‘å¸ƒé¢‘ç‡ï¼‰

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# reddit_stream_crawler.py
def stream_submissions(self, duration_seconds: int = None, stop_flag: callable = None):
    for submission in subreddit.stream.submissions(skip_existing=True):
        # ğŸ”¥ æ¯æ¬¡è¿­ä»£æ£€æŸ¥åœæ­¢æ ‡å¿—
        if stop_flag and stop_flag():
            logger.info(f"ğŸ›‘ æ”¶åˆ°åœæ­¢ä¿¡å·ï¼Œé€€å‡ºç›‘å¬")
            break
```

```python
# control_center.py
stats = self.stream_crawler.stream_submissions(
    duration_seconds=None,
    stop_flag=lambda: not self.stream_enabled  # ğŸ”¥ è¿”å› True æ—¶åœæ­¢
)
```

---

### 2. âš ï¸ **å˜é‡ä½œç”¨åŸŸé—®é¢˜** (å·²ä¿®å¤)
**ä½ç½®**: `control_center.py::main()`

**é—®é¢˜æè¿°**:
- `center` å˜é‡åœ¨ `try` å—å†…å®šä¹‰
- `finally` å—ä¸­è®¿é—® `center` å¯èƒ½å¯¼è‡´ `NameError`ï¼ˆå¦‚æœåˆå§‹åŒ–å¤±è´¥ï¼‰

**ä¿®å¤æ–¹æ¡ˆ**:
```python
def main():
    center = None  # ğŸ”¥ åˆå§‹åŒ–ä¸º Noneï¼Œç¡®ä¿ finally å—å¯ä»¥è®¿é—®
    try:
        center = CrawlerControlCenter()
        ...
    finally:
        if center:  # ğŸ”¥ æ£€æŸ¥ center æ˜¯å¦å·²åˆ›å»º
            if center.stream_enabled and center.stream_thread:
                center.stop_stream_monitoring()
```

---

### 3. âš ï¸ **ä¿¡å·å¤„ç†ç¼ºå¤±** (å·²ä¿®å¤)
**ä½ç½®**: `reddit_stream_crawler.py::main()`

**é—®é¢˜æè¿°**:
- ç‹¬ç«‹è¿è¡Œæ—¶ï¼Œ`Ctrl+C` è§¦å‘ `KeyboardInterrupt`ï¼Œä½†å¼‚å¸¸æ•è·åœ¨ `try/except` å—å¤–
- æ— æ³•ä¼˜é›…ä¸­æ–­ `stream.submissions()` è¿­ä»£å™¨

**ä¿®å¤æ–¹æ¡ˆ**:
```python
def main():
    stop_requested = False
    
    def signal_handler(sig, frame):
        nonlocal stop_requested
        logger.info("\nâš ï¸  æ”¶åˆ°åœæ­¢ä¿¡å· (Ctrl+C)")
        stop_requested = True
    
    signal.signal(signal.SIGINT, signal_handler)
    
    stats = crawler.stream_submissions(
        duration_seconds=None,
        stop_flag=lambda: stop_requested  # ğŸ”¥ æ£€æŸ¥åœæ­¢æ ‡å¿—
    )
```

---

## âœ… å·²éªŒè¯çš„æ­£ç¡®å®ç°

### 1. âœ… **çº¿ç¨‹å®‰å…¨è®¾è®¡**
- `stream_thread` è®¾ç½®ä¸º `daemon=True`ï¼Œä¸»ç¨‹åºé€€å‡ºæ—¶ä¼šè‡ªåŠ¨æ¸…ç†
- `stop_stream_monitoring()` ä½¿ç”¨ `join(timeout=5)` é¿å…æ— é™ç­‰å¾…
- `stream_enabled` å¸ƒå°”æ ‡å¿—çš„åŸå­æ€§æ“ä½œï¼ˆPython GIL ä¿è¯ï¼‰

### 2. âœ… **è‡ªåŠ¨é‡è¿æœºåˆ¶**
```python
while self.stream_enabled:
    try:
        stats = self.stream_crawler.stream_submissions(...)
        retry_count = 0  # æˆåŠŸåé‡ç½®
    except Exception as e:
        retry_count += 1
        if retry_count > max_retries:
            break
        wait_time = min(30 * retry_count, 300)  # æŒ‡æ•°é€€é¿
        time.sleep(wait_time)
```

### 3. âœ… **èµ„æºæ¸…ç†**
```python
finally:
    if center:  # æ£€æŸ¥æ˜¯å¦å·²åˆ›å»º
        try:
            if center.stream_enabled:
                center.stop_stream_monitoring()
        except:
            pass
        
        try:
            center.close()  # å…³é—­ Redis è¿æ¥
        except:
            pass
```

### 4. âœ… **é…ç½®æ­£ç¡®æ€§**
- `config.yaml` ä¸­ `stream_enabled: true` æ­£ç¡®è®¾ç½®
- ä¸ `reddit_crawler` å…±äº«é…ç½®ï¼ˆsubreddits, keywords, filtersï¼‰
- å†™å…¥åŒä¸€ Redis DB0 é˜Ÿåˆ—ï¼ˆ`data_queue`ï¼‰

---

## ğŸ”„ ä¿®æ”¹æ–‡ä»¶æ¸…å•

1. **`scraper/crawlers/reddit_stream_crawler.py`**
   - æ·»åŠ  `stop_flag` å‚æ•°åˆ° `stream_submissions()`
   - ä¿®æ”¹ `main()` å‡½æ•°æ·»åŠ ä¿¡å·å¤„ç†

2. **`scraper/control_center.py`**
   - ä¿®æ”¹ `start_stream_monitoring()` ä¼ å…¥ `stop_flag=lambda: not self.stream_enabled`
   - ä¿®æ”¹ `main()` åˆå§‹åŒ– `center = None`
   - ä¿®æ”¹ `finally` å—æ·»åŠ  `if center:` æ£€æŸ¥

3. **`scraper/config.yaml`**
   - âœ… æ— éœ€ä¿®æ”¹ï¼ˆå·²æ­£ç¡®é…ç½®ï¼‰

4. **`scraper/start_stream_crawler.bat`**
   - âœ… æ— éœ€ä¿®æ”¹ï¼ˆå·²æ­£ç¡®å®ç°ï¼‰

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯ 1: æ­£å¸¸å¯åŠ¨ä¸åœæ­¢
```bash
cd scraper
python control_center.py
# é€‰æ‹© 3 (å¾ªç¯æ¨¡å¼)
# è§‚å¯Ÿæ˜¯å¦å¯åŠ¨å®æ—¶æµ
# æŒ‰ Ctrl+C æ£€æŸ¥æ˜¯å¦ä¼˜é›…é€€å‡º
```

**é¢„æœŸç»“æœ**:
- âœ… æ˜¾ç¤º "ğŸ”´ å¯åŠ¨ Reddit å®æ—¶æµå¼ç›‘å¬"
- âœ… æ˜¾ç¤º "ğŸ”´ è¿è¡Œä¸­" çŠ¶æ€
- âœ… Ctrl+C åæ˜¾ç¤º "ğŸ›‘ æ”¶åˆ°åœæ­¢ä¿¡å·"
- âœ… 5 ç§’å†…å®Œæˆé€€å‡º

---

### æµ‹è¯•åœºæ™¯ 2: ç‹¬ç«‹è¿è¡Œ
```bash
cd scraper
start_stream_crawler.bat
# æŒ‰ Ctrl+C åœæ­¢
```

**é¢„æœŸç»“æœ**:
- âœ… æ˜¾ç¤º "ğŸ”´ å¯åŠ¨å®æ—¶ç›‘å¬"
- âœ… å®æ—¶æ•è·æ–°å¸–å­å¹¶æ˜¾ç¤ºæ—¥å¿—
- âœ… Ctrl+C åæ˜¾ç¤º "âš ï¸  æ”¶åˆ°åœæ­¢ä¿¡å·"
- âœ… æ˜¾ç¤º "âœ… ç›‘å¬å·²åœæ­¢"

---

### æµ‹è¯•åœºæ™¯ 3: è‡ªåŠ¨é‡è¿
```bash
# æ¨¡æ‹Ÿç½‘ç»œä¸­æ–­ï¼ˆæ–­å¼€ Wi-Fi 30 ç§’åé‡è¿ï¼‰
```

**é¢„æœŸç»“æœ**:
- âœ… æ˜¾ç¤º "âŒ Reddit API é”™è¯¯"
- âœ… æ˜¾ç¤º "â³ 30ç§’åè‡ªåŠ¨é‡è¿..."
- âœ… é‡è¿åç»§ç»­ç›‘å¬

---

### æµ‹è¯•åœºæ™¯ 4: ç»Ÿè®¡æ˜¾ç¤º
```bash
# è¿è¡Œ 10 åˆ†é’Ÿåæ£€æŸ¥ç»Ÿè®¡
```

**é¢„æœŸç»“æœ**:
- âœ… `_print_statistics()` æ˜¾ç¤º "Redditå®æ—¶: å¸–å­ X, é”™è¯¯ Y ğŸ”´ è¿è¡Œä¸­"
- âœ… æ‰¹é‡çˆ¬è™«ç»Ÿè®¡ä¸å®æ—¶æµç»Ÿè®¡åˆ†å¼€æ˜¾ç¤º

---

## ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ

### ç«‹å³éªŒè¯
```bash
cd scraper
python control_center.py
```
é€‰æ‹© `3 (å¾ªç¯æ¨¡å¼)`ï¼Œè§‚å¯Ÿ:
1. æ˜¯å¦å¯åŠ¨å®æ—¶æµ
2. æ˜¯å¦æ˜¾ç¤º "ğŸ”´ è¿è¡Œä¸­"
3. æŒ‰ Ctrl+C æ˜¯å¦ä¼˜é›…é€€å‡º

### é•¿æœŸæµ‹è¯•
- è¿è¡Œ 24 å°æ—¶è§‚å¯Ÿç¨³å®šæ€§
- æ£€æŸ¥å†…å­˜æ˜¯å¦æ³„æ¼ï¼ˆä»»åŠ¡ç®¡ç†å™¨ï¼‰
- éªŒè¯ Redis æ•°æ®æ˜¯å¦æ­£å¸¸å†™å…¥
- ç¡®è®¤æ¸…æ´—å™¨æ˜¯å¦æ­£å¸¸è§¦å‘

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### é¢„æœŸå»¶è¿Ÿ
- **æ‰¹é‡çˆ¬è™«**: 1-2 å°æ—¶ï¼ˆä½¿ç”¨ rising+newï¼‰
- **å®æ—¶æµ**: < 1 åˆ†é’Ÿï¼ˆStream APIï¼‰

### èµ„æºæ¶ˆè€—
- **å†…å­˜**: ~50-100MBï¼ˆå†…å­˜ç¼“å­˜ 10k æ¡ï¼‰
- **CPU**: < 5%ï¼ˆç­‰å¾…ç½‘ç»œ I/Oï¼‰
- **ç½‘ç»œ**: ~100KB/minï¼ˆå–å†³äºå¸–å­é¢‘ç‡ï¼‰

---

## âš ï¸ å·²çŸ¥é™åˆ¶

1. **åœæ­¢å»¶è¿Ÿ**: æœ€å¤šéœ€è¦ç­‰å¾…ä¸‹ä¸€ä¸ªå¸–å­ï¼ˆå¹³å‡ 10-30 ç§’ï¼‰
2. **å»é‡ç¼“å­˜**: è¾¾åˆ° 10k æ¡åä¼šæ¸…ç©ºï¼ˆå¯èƒ½çŸ­æš‚é‡å¤ï¼‰
3. **Reddit é™æµ**: æ¯åˆ†é’Ÿ 60 æ¬¡ API è°ƒç”¨ä¸Šé™ï¼ˆPRAW è‡ªåŠ¨å¤„ç†ï¼‰

---

## ğŸ‰ ä¿®å¤å®Œæˆ

æ‰€æœ‰å·²çŸ¥é”™è¯¯å·²ä¿®å¤ï¼Œä»£ç ç°åœ¨åº”è¯¥å¯ä»¥ç¨³å®šè¿è¡Œã€‚

**æ ¸å¿ƒæ”¹è¿›**:
- âœ… ä¼˜é›…ä¸­æ–­æœºåˆ¶ï¼ˆstop_flag å›è°ƒï¼‰
- âœ… å˜é‡ä½œç”¨åŸŸå®‰å…¨ï¼ˆcenter = Noneï¼‰
- âœ… ä¿¡å·å¤„ç†å®Œå–„ï¼ˆsignal.SIGINTï¼‰
- âœ… çº¿ç¨‹å®‰å…¨ä¿è¯ï¼ˆdaemon + joinï¼‰
- âœ… èµ„æºæ¸…ç†å®Œæ•´ï¼ˆfinally å—ï¼‰

---

**ä¿®å¤è€…**: GitHub Copilot  
**éªŒè¯çŠ¶æ€**: â³ å¾…ç”¨æˆ·æµ‹è¯•
