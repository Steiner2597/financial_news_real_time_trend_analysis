# 数据清洗时间字段修改对比

## 📊 修改前后对比

### 修改前 ❌
```
使用字段: timestamp
含义: Cleaner 处理数据时的当前时间
问题: 所有数据的处理时间都很近（都在最近几小时内）
      导致无法正确区分哪些是真正的旧数据
```

### 修改后 ✅
```
使用字段: created_at（优先），timestamp（备用）
含义: 数据的原始发布时间（新闻/评论的发表时间）
优势: 能准确判断数据的真实发布时间
      正确清理超过24小时的旧数据
```

---

## 🕐 时间字段说明

| 字段 | 来源 | 含义 | 用途 | 示例 |
|------|------|------|------|------|
| **created_at** | 原始数据 | 数据在源头的发布时间 | 判断数据的真实年龄 | Reddit评论发表于 2025-11-01 10:30 |
| **timestamp** | Cleaner处理 | 数据被处理的时间 | 追踪处理流程时间 | Cleaner处理于 2025-11-02 15:30 |
| **cleaned_at** | Cleaner处理 | 数据完成清洗的时间 | 追踪清洗完成时间 | 清洗完成于 2025-11-02 15:30:45 |

---

## 📈 实际场景示例

### 场景：保留24小时内的数据

**当前时间**：2025-11-02 15:30:45
**当前整点**：2025-11-02 15:00:00
**保留范围**：2025-11-01 15:00:00 ~ 现在

#### 数据A（旧评论）
```json
{
  "text": "...老评论...",
  "created_at": "2025-11-01 10:00:00",  ← 原始发布时间（1天多前）
  "timestamp": "2025-11-02 15:00:00",    ← 处理时间（今天）
}
```
**判断**：
- ❌ 修改前：看 timestamp 是今天 → 保留 ❌ 错误！
- ✅ 修改后：看 created_at 是1天多前 → 删除 ✓ 正确！

#### 数据B（新评论）
```json
{
  "text": "...最新评论...",
  "created_at": "2025-11-02 14:30:00",  ← 原始发布时间（最近）
  "timestamp": "2025-11-02 15:30:00",    ← 处理时间（今天）
}
```
**判断**：
- ❌ 修改前：看 timestamp 是今天 → 保留 ✓ 正确（但理由不对）
- ✅ 修改后：看 created_at 在24小时内 → 保留 ✓ 正确！

---

## 🔍 时间检查算法

```python
# 1. 获取当前整点时刻
now = datetime.now(timezone.utc)
current_hour = now.replace(minute=0, second=0, microsecond=0)
# 2025-11-02 15:00:00

# 2. 计算删除阈值（当前整点 - 24小时）
cutoff_time = current_hour - timedelta(hours=24)
# 2025-11-01 15:00:00

# 3. 对每条数据进行检查
if 'created_at' in data:
    data_time = parse(data['created_at'])
else:
    data_time = parse(data['timestamp'])

# 4. 判断是否删除
if data_time < cutoff_time:
    delete_data()  # 发布时间早于阈值 → 删除
else:
    keep_data()    # 发布时间在范围内 → 保留
```

---

## 📝 代码修改位置

**文件**：`cleaner/services/cleaner.py`
**方法**：`EventDrivenCleaner._clean_old_data()`
**行数**：约 265-330

### 主要改动

```python
# 优先使用 created_at（原始发布时间），其次使用 timestamp
if 'created_at' in data:
    time_field = 'created_at'
elif 'timestamp' in data:
    time_field = 'timestamp'
else:
    continue  # 跳过没有时间字段的数据

time_value = data[time_field]
# 转换为时间戳并进行比较
```

---

## ✨ 清理结果验证

运行清洗器后，查看日志输出：

```
✅ 清理完成:
   📊 总检查数据: 18386 条
   🗑️  已删除数据: 5000 条 (created_at < 2025-11-01T15:00:00)
   ✨ 保留数据: 13386 条 (created_at >= 2025-11-01T15:00:00)
   📌 判断依据: created_at 字段 (原始发布时间) / timestamp
   🎯 时间窗口: 2025-11-01T15:00:00 到 现在
```

- ✅ 确认使用的是 `created_at` 字段
- ✅ 确认保留了24小时内的数据
- ✅ 确认删除了超过24小时的旧数据
