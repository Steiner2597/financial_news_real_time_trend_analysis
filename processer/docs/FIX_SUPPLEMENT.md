# Processor 24 小时历史数据生成 - 修改补充说明

## 修复的问题

### 问题 1：时间窗口少了一个小时
- **现象**：最新数据是 9:50，但词频统计最新时间是 8:00（少了一个小时）
- **原因**：向下取整到整点时，9:50 被取整为 9:00，导致当前小时（9:00-10:00）的数据没有被完全包含
- **解决方案**：**向上取整**到下一个整点，9:50 → 10:00

### 问题 2：history_data 包含的词数一直增加
- **现象**：history_data 中的词数不固定，有时 15 个，有时 20 多个，一直在增加
- **原因**：使用了 `self.config['trending_keywords_count']`，这个配置可能被修改
- **解决方案**：**固定为 20 个词**，不依赖配置

## 具体修改

### 修改 1：`data_loader.py` - `get_time_windows()`

**关键逻辑变更：**

```python
# ❌ 旧逻辑：向下取整（会漏掉当前小时）
latest_hour = latest_time.replace(minute=0, second=0, microsecond=0)
history_window_start = latest_hour - timedelta(hours=24)

# ✅ 新逻辑：向上取整到下一个整点（确保包含当前小时）
if latest_time.minute > 0 or latest_time.second > 0 or latest_time.microsecond > 0:
    latest_hour = (latest_time + timedelta(hours=1)).replace(minute=0, second=0, microsecond=0)
else:
    latest_hour = latest_time.replace(minute=0, second=0, microsecond=0)

# 向前推 25 小时（不是 24 小时）
history_window_start = latest_hour - timedelta(hours=25)
```

**时间窗口示例：**
```
最新数据: 2025-11-03T09:50:32Z
向上取整: 2025-11-03T10:00:00Z
历史起点: 2025-11-02T09:00:00Z（向前推 25 小时）
历史终点: 2025-11-03T10:00:00Z

生成的 24 个时间槽：
  1. [2025-11-02T09:00:00Z, 2025-11-02T10:00:00Z]
  2. [2025-11-02T10:00:00Z, 2025-11-02T11:00:00Z]
  ...
  24. [2025-11-03T09:00:00Z, 2025-11-03T10:00:00Z]
```

### 修改 2：`main.py` - 历史数据生成

**关键变更：**

```python
# ❌ 旧逻辑：从配置中读取，可能变化
top_keywords = [keyword for keyword, _ in current_keywords[:self.config['trending_keywords_count']]]

# ✅ 新逻辑：固定为 20 个
top_keywords_count = 20  # 固定为 20
top_keywords = [keyword for keyword, _ in current_keywords[:top_keywords_count]]
```

**输出日志：**
```
📈 生成历史数据...
  📊 选取频率最高的 20 个词生成历史数据
```

## 输出验证

### 日志输出示例

```
📅 时间窗口计算（基于最新数据时间）:
  时间字段: created_at ✅
  最新数据时间: 2025-11-03T09:50:32Z
  最新整点（向上取整）: 2025-11-03T10:00:00Z ✅
  历史窗口: 2025-11-02T09:00:00Z ~ 2025-11-03T10:00:00Z
  时间跨度: 25 小时（生成 24 个整点数据点） ✅

✓ 当前窗口数据（最近1小时）: 156 条
  时间范围: 2025-11-03T09:50:32Z ~ 2025-11-03T10:00:00Z
✓ 历史窗口数据（完整24小时）: 2548 条
  时间范围: 2025-11-02T09:00:00Z ~ 2025-11-03T10:00:00Z

📈 生成历史数据...
  📊 选取频率最高的 20 个词生成历史数据

📊 历史数据生成配置:
  时间字段: created_at ✅
  时间窗口: 2025-11-02T09:00:00Z ~ 2025-11-03T10:00:00Z
  时间区间数: 24 个（应为 24 个） ✅
```

### 输出 JSON 验证

**history_data 结构：**
```json
{
  "history_data": {
    "keyword1": [
      {"timestamp": "2025-11-02T09:00:00Z", "frequency": 123},
      {"timestamp": "2025-11-02T10:00:00Z", "frequency": 145},
      ...
      {"timestamp": "2025-11-03T09:00:00Z", "frequency": 156}
    ],
    "keyword2": [...],
    ...
    "keyword20": [...]
  }
}
```

**验证清单：**
- ✅ 最后一个时间戳：`2025-11-03T09:00:00Z`（最新整点 - 1 小时）
- ✅ 第一个时间戳：`2025-11-02T09:00:00Z`（向前 24 小时）
- ✅ 时间槽数：24 个
- ✅ 关键词数：20 个（固定值）

## 修改文件清单

| 文件 | 修改内容 |
|------|---------|
| `data_loader.py` | 修改 `get_time_windows()` - **向上取整**到下一个整点，向前推 **25 小时** |
| `main.py` | 修改历史数据生成 - **固定为 20 个词** |
| `history_analyzer.py` | 更新文档注释，明确说明 25 小时生成 24 个槽 |
| `test_24hour_history.py` | 更新测试逻辑 - 验证 25 小时和 20 个词 |

## 时间取整对比

### ❌ 错误方式（向下取整）
```
最新数据: 09:50
向下取整: 09:00
推回 24h: 08:00 前一天
结果: 最新数据点是 09:00（漏掉了 09:50 之后直到下一个整点的数据）
```

### ✅ 正确方式（向上取整）
```
最新数据: 09:50
向上取整: 10:00
推回 25h: 09:00 前一天
结果: 最新数据点是 09:00（包含了 09:00-10:00 之间的所有数据，包括 09:50）
实际覆盖时间: [09:00 前一天, 10:00 当天] = 完整 24 小时 + 1 小时边界
```

## 后续验证步骤

1. ✅ 运行 `main.py`
2. ✅ 检查日志中是否显示"最新整点（向上取整）"
3. ✅ 检查日志中是否显示"25 小时（生成 24 个整点数据点）"
4. ✅ 检查日志中是否显示"选取频率最高的 20 个词"
5. ✅ 检查输出的 `output_data.json`
   - `history_data` 中每个关键词是否有 **24 个**数据点
   - `history_data` 中是否有 **20 个**关键词
   - 最后一个时间戳是否正确（最新整点 - 1 小时）
